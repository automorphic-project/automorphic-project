\input{preamble}

% OK, start here.
%
\begin{document}

\title{The automorphic space}


\maketitle

\phantomsection
\label{section-phantom}

\tableofcontents

\section{The automorphic quotient, and basic examples}
\label{section-automorphic-quotient}

Automorphic representations are the representations that appear when we perform harmonic analysis on the homogeneous space $G(k)\backslash G(\mathbb A)$, where $k$ is a global field and $\mathbb A$ is its ring of adeles. 


Let $G$ be a linear algebraic group over $k$. Since $G$ is affine, the subgroup $G(k)$ of $G(\mathbb A)$ is discrete and the space $[G]:=G(k)\backslash G(\mathbb A)$ is a locally compact space, homogeneous under the action of $G(\mathbb A)$. It carries an invariant measure under $G(\mathbb A)$.

\begin{definition}
 \label{definition-automorphic-space}
If $G$ is a linear algebraic group over $k$, the space $G(k)\backslash G(\mathbb A)$ is called the {\it automorphic space} of $G$, and denoted by $[G]$. 
\end{definition}
This term is not completely standard, but there is no other name for it. Here we study properties of this space, discuss the adelic and the classical picture, and some relevant arithmetic issues. We fix throughout a global field $k$ (either a number field, or the function field of a curve over a finite field), and all groups are linear algebraic groups defined over $k$. The letters $S, \Sigma$ will always denote finite sets of places of $k$, $\mathbb A^S$ will denote the adeles outside of $S$, i.e. the restricted product $\prod'_{v\notin S} k_v$, and $\mathbb A_S$ will denote the product $\prod_{v\in S} k_v$. For a variety $X$ over $S$ we will denote: $X_k:=X(k)$, $X_{\mathbb A}:=X(\mathbb A)$, $X^S:= X(\mathbb A^S)$ and $X_S:= X(\mathbb A_S)$. The (finite) set of archimedean places will be denoted by $\infty$. If $k$ is a function field, we pick a place that we denote by $\infty$. We let $\mathfrak o$ be the ring of integers of $k$, if $k$ is a number field, and the ring of integers away from the chosen place $\infty$, if $k$ is a function field. We let $\mathbb A_f = \mathbb A^\infty$, the ring of finite adeles, when $k$ is a number field, and the ring of adeles away from $\infty$, when $k$ is a function field. 



\subsection{The additive group}
\label{subsection-additive}

\begin{proposition}
\label{proposition-automorphic-Ga}
Let $G = \mathbb G_a$. The automorphic space $[G]$ is compact, and for any non-empty set $S$ of places of $k$, the embedding $k\hookrightarrow \mathbb A^S$ is dense. In particular, for 
every open compact $K\subset \mathbb A_f$, the group $k_\infty$ acts with a unique orbit on the quotient space $[G]/K$, which is isomorphic to $k_\infty / \mathfrak o_K$ as a $k_\infty$-space, for a subgroup $\mathfrak o_K$ of $k_\infty$ that is finitely generated over the integers of the base field (i.e., over $\mathbb Z$ or $\mathbb F_q[t]$).
\end{proposition}

\begin{proof}
 By restriction of scalars, $\text{Res}_{k/\mathbb Q} \mathbb G_a = \mathbb G_a^{(k:\mathbb Q)}$, the problem reduces to the base field $k=\mathbb Q$ or $k=\mathbb F_q(t)$. We present only the case of $k=\mathbb Q$, $S=\{\infty\}$, leaving the general case as an exercise to the reader. In this case, we have $\mathbb A^S = \mathbb A_f = \widehat{\mathbb Z} \otimes \mathbb Q$, and the density statement follows from the density of $\mathbb Z$ in its profinite completion. 
 
 The stabilizer for the action of $k_\infty$ on $[G]/K$ is the intersection $k\cap K k_\infty$. This is a submodule for $\mathbb Z$ or $\mathbb F_q[t]$, because every open compact subgroup $K$ is (exercise!). It is finitely generated, because this is the case when $K = N \cdot \prod_v \mathfrak o_v$ for some $N\in k^\times$, and any compact open $K$ is contained in such a subgroup.
 
 In the particular case $K = \prod_v \mathfrak o_v$, we obtain the quotient $k_\infty/\mathfrak o$, which is compact, hence $[G]$ is compact.
\end{proof}




\subsection{The multiplicative group}
\label{subsection-multiplicative}


\begin{proposition}
\label{proposition-automorphic-Gm}
 Let $G=\mathbb G_m$. The product of absolute values defines a homomorphism $[G]\to \mathbb R^\times_+$, whose kernel is compact. If $K\subset \mathbb A_f^\times$ is the maximal compact subgroup (the product of local units), then the $k_\infty^\times$-orbits on $[G]/K$ are canonically parametrized (under the natural homomorphism from ideles to fractional ideals, sending a uniformizer at a finite place to the corresponding ideal) by the class group of $k$, and each is isomorphic to $k_\infty^\times / \mathfrak o^\times$. The orbits of the identity component $(k_\infty^\times)^0$ are parametrized by the narrow class group of $k$.
 
 More generally, if $K = \prod_{v\notin S} \mathfrak o_v^\times \prod_{v\in S} (1+\mathfrak p_v^{r_v})$, where $S$ is a finite set of finite primes, the $k_\infty^\times$-orbits on $[G]/K$ are canonically parametrized by the ray class group of modulus $\mathfrak m = \prod_{v\in S} \mathfrak p_v^{r_v}$, and the $(k_\infty^\times)^0$-orbits by the corresponding narrow ray class group.
\end{proposition}

\begin{proof}
 Recall that for an idele $a = (a_v)_v$, the absolute value $|a|$ is the scalar by which it acts on a Haar measure on $\mathbb A$. Fix that Haar measure $\mu$ for which the quotient measure on $[\mathbb G_a]$ is $1$. (This makes sense by compactness of $[\mathbb G_a]$.) For every $c>0$, if $|a|>c^{-1}$ and $C$ is a compact subset of $\mathbb A$ with $\mu(C) >c$, then $\mu(aC)>1$, therefore the map $aC\to [\mathbb G_a]$ is not injective, which means that there exist $c_1, c_2\in C$ and $q\in k^\times$ with $a(c_1-c_2) =q$. Equivalently, $qa^{-1}$ belongs to the compact set $C-C \subset \mathbb A$ of differences of elements of $C$. Similarly, if $|a|<c$ then $q' \cdot a \in (C-C)$, for some $q'\in k^\times$. Note, also, that $q\cdot q' = qa^{-1} \cdot q'a  \in (C-C)\cdot (C-C)$, which is also a compact set, hence meets the discrete set $k^\times $ in a finite set of elements $\gamma_1, \gamma_2, \dots, \gamma_n$. Therefore, $q' = \gamma_i q^{-1}$ for some $i$, and we get that under the closed embedding
 \[ \mathbb A^\times \ni z \mapsto (z, z^{-1}) \in \mathbb A^2,\]
 the element $q'a$ maps into the compact set $(C-C) \times \sqcup_i \gamma_i^{-1}(C-C)$.
 
 Thus, the closed subset $[G]^{[c^{-1}, c]}$ of idele classes whose absolute value belongs to the interval $[c^{-1},c]$ is compact, and therefore the same is true for the kernel $[G]^1$ of the absolute value map.
 
 The rest are left to the reader.
\end{proof}


Notice that this implies the Dirichlet unit theorem:

\begin{proposition}
 \label{proposition-Dirichlet-unit}
If $F$ is a number field, with $r_1$ real places and $r_2$ complex places, then the unit group $\mathfrak o^\times$ is a finitely generated abelian group of rank $r_1+r_2-1$.
\end{proposition}

\begin{proof}
 If $K = \prod_{v<\infty} \mathfrak o_v^\times$, then $[\mathbb G_m] = k^\times_\infty /\mathfrak o^\times$, and the logarithm of the Archimedean absolute values define a surjection $k^\times_\infty \to \mathbb R^{r_1+r_2}$ with compact kernel. This kernel, intersected with the discrete subgroup $\mathfrak o^\times$, is finite (the torsion subgroup of $\mathfrak o^\times$), while the image of $\mathfrak o^\times$ will be a discrete subgroup, and by Proposition \ref{proposition-automorphic-Gm} it will be cocompact inside the kernel of $\mathbb R^{r_1+r_2}\xrightarrow{\sum} \mathbb R$. Therefore, it is a finitely generated abelian group of rank $r_1+r_2-1$.
\end{proof}




\subsection{Tori}
\label{subsection-tori}

\begin{proposition}
\label{proposition-automorphic-tori}
 Let $T$ be a torus over $k$. Let $X^*_k(T)$ be the $k$-character group of $T$, and $\mathfrak a = \Hom(X^*_k(T) , \mathbb R)$. The map $X^*_k(T) \times [T] \ni (\chi, t) \mapsto \log(|\chi(t)|)$ defines a homomorphism $\log_T:[T]\to\mathfrak a$ with compact kernel and cokernel. In particular, $[T]$ is compact if and only if $T$ is anisotropic.  
\end{proposition}

\begin{proof}
 The only nontrivial statement is that the kernel of $\log_T$ is compact.  Let $[T]^1$ be this kernel (and similarly for any torus). 
 
 First, reduce to the case when $T$ is anisotropic: if $T_1$ is the kernel of all morphisms to $\mathbb G_m$, the quotient $T/T_1$ is isomorphic to $\mathbb G_m^r$ for some $r$, and we have a map $[T]^1 \to [T/T_1]^1$ with kernel $[T_1]$. The case of $\mathbb G_m$ has already been treated in Proposition \ref{proposition-automorphic-Gm}, so we are reduced to the case $T=T_1$, i.e., $T$ is anisotropic.
 
 Assume this to be the case. By Lemma \ref{algebraicgroups-lemma-induced-tori}, there is an induced torus $S$, together with a surjection $S\twoheadrightarrow T$. If $S_1$ denotes the common kernel of all characters of $S$, since $T$ is anisotropic, we have a surjection $S_1\twoheadrightarrow T$. By Proposition \ref{proposition-automorphic-Gm}, $[S_1]$ is compact. On the other hand, the image of the map $[S_1]\to [T]$ will have finite index modulo any compact open subgroup of $T(\mathbb A)$ (exercise!). Therefore, $[T]$ is compact.
\end{proof}

\begin{remark}
 \label{remark-Dirichlet-unit-torus}
 Generalizing the Dirichlet unit theorem \ref{proposition-Dirichlet-unit}, for a torus $T$ over $\mathbb Q$, the group $T(\mathbb Z)$ is a finitely generated abelian group of rank equal to $\mbox{splr}_{\mathbb R}(T) - \mbox{splr}_{\mathbb Q}(T)$, where $\mbox{splr}$ denotes the split rank (the rank of the character group) of the torus over the indicated field.
\end{remark}



\section{Parabolic automorphic spaces}
\label{section-boundary-degenerations}

When studying the geometry and harmonic analysis of the space $[G]$, a very important role is played by certain related $G(\mathbb A)$-homogeneous spaces, that we will call \emph{parabolic automorphic spaces}, or \emph{boundary degenerations}. The last term is not standard, but is borrowed from \cite{Sakellaridis-Venkatesh}, where it was used in a local setting, and it is a useful concept that unifies the ideas of harmonic analysis globally and locally.

Let $\mathcal P$ denote a (conjugacy) class of parabolics in $G$; it can be understood as a homogeneous space of $G$, endowed with the tautological sub-group scheme $\mathbb P$ of the constant scheme $\mathcal P\times G$, where the fiber of $\mathbb P$ over a parabolic $P$ is $P$ itself. It admits a canonical quotient $\mathbb L$, where the fiber over $P$ is the Levi quotient of $P$, and a further canonical quotient $\mathbb L^{ab}$, where the fiber is the abelianization of the Levi quotient. Notice that the action of $P$ is trivial on its fiber in $\mathbb L^{ab}$, but not on its fiber in $\mathbb L$, unless $\mathcal P = \mathcal B$, the class of Borel subgroups, where the group scheme $\mathbb L$ is the constant ``universal Cartan'' group scheme (Definition \ref{algebraicgroups-definition-universal-Cartan}), $\mathbb L = \mathbf A^G\times \mathcal B$. 

\begin{definition}
 \label{definition-pre-flag}
Let $G$ be a reductive group over a field $k$, let $\mathcal P$ denote a (conjugacy) class of parabolics in $G$, and let $\mathbb L$ be the group scheme of Levi quotients over $\mathcal P$. A {\it pre-flag variety} [can someone suggest a better term?] associated to $\mathcal P$ is a $G$-equivariant $\mathbb L$-torsor $R$ over $\mathcal P$, where any $P\in \mathcal P$ acts on its fiber $R_P$ through its Levi quotient $P\to \mathbb L_P$. A {\it degenerate pre-flag variety} is a $G$-equivariant $\mathbb L^{ab}$-torsor $R$ over $\mathcal P$, where any $P\in \mathcal P$ acts on its fiber $R_P$ through its abelianized Levi quotient $P\to \mathbb L^{ab}_P$.
\end{definition}

\begin{remark}
\label{remark-pre-flag}
In this section, we will always take a (degenerate) pre-flag variety to have points over the field of definition, unless otherwise stated. In this case is isomorphic to $U_P\backslash G$ (resp.\ $[P,P]\backslash G$) --- but the definition is formulated in a way to avoid having a chosen base point. For example, if $\mathcal P=\{G\}$, then the pre-flag variety is simply a $G$-torsor. 

Clearly, the isomorphism class of the pre-flag variety (which has a point) depends only on the conjugacy class $\mathcal P$, but we will often abuse language, pick a parabolic $P \in \mathcal P$, and say that $U_P\backslash G$ is ``the'' pre-flag variety associated to $P$ --- but without a fixed point, unless otherwise stated.
\end{remark}



\begin{definition}
 \label{definition-boundary-degeneration}
Let $G$ be a reductive group over a global field $k$, and $\mathcal P$ a class of parabolics. Fix a pre-flag variety $Y$ associated to $\mathcal P$.
The {\it parabolic automorphic space} or {\it boundary degeneration} $[G]_{\mathcal P}$ of the automorphic space $[G]$ associated to these data is the set of pairs $(y \in M)$, where $M$ is a $G(\mathbb A)$-translate of $Y(k)$ in $Y(\mathbb A)$, and $y\in M$,  modulo the action of $\text{Aut}^G(Y)(k)$. 

Equivalently, fixing a base point $P\in \mathcal P(k)$ with unipotent radical $U$ and Levi quotient $L$, the boundary degeneration $[G]_{\mathcal P}$, which by abuse of notation will also be denoted by $[G]_P$, is the space $L(k)U(\mathbb A)\backslash G(\mathbb A)$.
\end{definition}

\begin{remark}
 \label{remark-boundary-degeneration}
For a different choice of parabolic $P'= L' U'\in \mathcal P(k)$, there is a canonical isomorphism $ L(k)U(\mathbb A)\backslash G(\mathbb A) \simeq L'(k)U'(\mathbb A)\backslash G(\mathbb A)$, induced by translation by an element of $G(k)$, which is unique modulo left $P(k)$-translation. Hence, in this case, there is no ambiguity in saying that $[G]_{\mathcal P}$ is ``the'' space $L(k)U(\mathbb A)\backslash G(\mathbb A)$.
\end{remark}

\begin{remark}
 \label{remark-bdrydegen-as-induction}
Here is an alternate, and more straightforward construction of the boundary degeneration: For every class $\mathcal P$ of parabolics over $k$, the Levi quotients $L$ of any two elements of $\mathcal P$ are isomorphic, canonically up to $L(k)$-conjugacy. (As in the case of the universal Cartan: the parabolics are conjugate by an element of $G(k)$ unique up to multiplication by $P(k)$.)

Choosing such a parabolic with Levi quotient $L$, we have 
\begin{equation}
 \label{equation-bdrydegen-as-induction}
[G]_P = [L]\times^{P(\mathbb A)} G(\mathbb A).
\end{equation}
One easily checks that for any two parabolics, any element of $G(k)$ conjugating one to another defines the same isomorphism between the corresponding spaces defined by \eqref{equation-bdrydegen-as-induction}.

Finally, another way to define the same space is the following: Consider $\mathcal P$ as an algebraic variety, and consider the space
$$ Z= \mathcal P(k)\times^{G(k)} G(\mathbb A).$$
If we choose a $P\in \mathcal P(k)$, this is isomorphic to $P(k)\backslash G(\mathbb A)$. Now, the inertia group scheme of $\mathcal P$ has fiber $P$ over the point $P$, and its unipotent radical is a group scheme $\mathbf U\to \mathcal P$. If we divide the space $Z$, which lives over $\mathcal P(\mathbb A)$, by the action of $\mathbf U(\mathbb A)$, we obtain the space $[G]_P$.
\end{remark}


The importance of boundary degenerations lies in the fact that, as we will see, they model the space $[G]$ ``at infinity'', while having a larger group of symmetries:

\begin{lemma}
 \label{lemma-boundary-automorphisms}
Let $[G]_P$ be a boundary degeneration of the automorphic space, and let $Z$ be the center of the Levi quotient of $P$. The $G(\mathbb A)$-automorphism group of $[G]_P$ is identified with $[Z]$, through its action descending from the action on the pre-flag variety.
\end{lemma}

\begin{proof}
 The $G(\mathbb A)$-automorphism group is the quotient of the normalizer of $H:=L(k)U(\mathbb A)$ by $H$. The closure of the projection of $H$ to any place $v$ of $k$ is the parabolic $P(k_v)$, and since $P$ is self-normalizing, an adele of $G$ normalizing $H$ must lie in $P(\mathbb A)$. Then it acts on $L(\mathbb A)$ by conjugation, and in order to normalize $L(k)$ it has to belong to the center of $L(\mathbb A)$. 
\end{proof}


We will use the action of this abelian group in order to construct (partial) compactifications of the boundary degeneration (and, later, of the automorphic space). There are several slight variants of how to do it, but they all follow the same idea: Let $H\subset [Z]$ (with notation as in Lemma \ref{lemma-boundary-automorphisms}) be a subgroup, and let $\bar H$ be a partial compactification of $H$ (or a partial compactification of a $H$-torsor). Then, we can form the space 
$$\bar H \times^H [G]_P,$$
which is a partial compactification of $[G]_P$. Here, $A\times^H B$ denotes the \emph{topological} quotient of the product $A\times B$ by the action of $H$, i.e., by the equivalence relations $(ah,b) \sim (a, hb)$, $h\in H$.

In practice, $H$ will be the points of a torus and, $\bar H$ will arise from some toric variety. 
For what follows, if $T$ is any torus over a field $F$, we denote by the corresponding gothic lowercase letter the vector space $\mathfrak t:= \Hom(\mathbb G_m, T) \otimes \mathbb R$. If $F$ is a valued field (or ring), we have a well-defined logarithmic map
\begin{equation}
\label{equation-logmap}
\log: T(F)\to \mathfrak t
\end{equation}
given by $\left<\log(t), \chi\right> = \log|\chi(t)|$ for any $\chi\in \Hom(T,\mathbb G_m)$. The same definition can be given, globally, replacing $T(F)$ by $[T]$, and using the adelic absolute value.

Recall that a normal affine embedding $Y$ of a torus $T$ over a field $k$ is given by a \emph{strictly convex, rational polyhedral cone} $C\subset \mathfrak t$. The faces of this cone are in bijection with $T$-orbits on $Y$, in such a way that cocharacters $\lambda$ in the relative interior of a face are those for which $\lim_{t\to 0} \lambda(t)$ belongs to the corresponding orbit. (A ``face'', here, is the intersection with the kernel of a linear functional $\chi$ such that $\chi|_C \ge 0$; this way, $\{0\}$ is a face.) The bijection is closure-reversing, e.g., $\{0\}$ corresponds to the open orbit $T$, and the relative interior of $C$ corresponds to the unique closed orbit. More general normal embeddings of $T$ are described by \emph{fans} in $\mathfrak t$, i.e., collections of such cones closed under the operation of passing to a face of a cone and with disjoint relative interiors. 

Returning to our group $G$, let $\mathbf A^G$ be its universal Cartan (Definition \ref{algebraicgroups-definition-universal-Cartan}), and let $A\subset \mathbf A^G$ be its maximal split subtorus. 
We denote by $\mathfrak a^-\subset \mathfrak a$ the antidominant cone, and by $\mathfrak a^-_{ss}\subset \mathfrak a^-$ its intersection with the weight space of the associated semisimple group. Faces of $\mathfrak a^-$ (or $\mathfrak a^-_{ss}$) correspond to conjugacy classes of parabolic subgroups defined over $k$, and the span of the face $\mathfrak a_P^-$ (resp.\ $\mathfrak a_{ss,P}^-$) associated to $P$ will be denoted by $\mathfrak a_P$ (resp.\ $\mathfrak a_{ss,P}^-$). The center $Z$ of a Levi quotient as in Lemma \ref{lemma-boundary-automorphisms} is canonically a subgroup of $\mathbf A^G$, and the cocharacters in $\mathfrak a_P$ span the maximal split subtorus $A_P$ of $Z$.

Now, the face $\mathfrak a_{ss,P}^-\subset \mathfrak a_P$ defines an affine embedding $A_P \hookrightarrow \overline{A_P}$. We can define a corresponding partial compactification $\overline{[G]_P}$ of $[G]_P$, by either of the construction in the following definition:

\begin{definition}
 \label{definition-standard-embedding}
A {\it standard embedding} of the space $[G]_P$ is either of the following spaces:
\begin{itemize} 
 \item $\overline{A_P(k_\infty)^0} \times^{A_P(k_\infty)^0} [G]_P$, where $\overline{A_P(k_\infty)^0}$ is the closure of the identity component of $A_P(k_\infty)$ in $\overline{A_P}(k_\infty)$. This makes sense only if $k$ is a number field. When $k=\mathbb Q$ (which we can always assume, by restriction of scalars), it leads to the so-called \emph{reductive Borel--Serre compactification} \cite{Zucker-L2, Borel-Ji}. 
 \item $\overline{A_P}(k_\infty) \times^{A_P(k_\infty)} [G]_P$. Recall that, in the function field case, we just pick a place (or a place of the base field) that we call infinity.
 \item $\overline{A_P}(k)A_P(\mathbb A) \times^{A_P(\mathbb A)} [G]_P$. Here, $\overline{A_P}(k)A_P(\mathbb A)$ is the subset of ``primitive elements'' in $\overline{A_P}(\mathbb A)$. Notice that $A_P(\mathbb A)$ is not open in the space $\overline{A_P}(\mathbb A)$, but it is open in the subset of primitive elements (with the induced topology). 
\end{itemize}
\end{definition}

\begin{remark}
 \label{remark-RBS-Satake}
The ``reductive Borel--Serre compactification'', although defined in a different way, is closely related to the compactification of Satake \cite{Satake-compactifications}, which is constructed starting from compactifications of the symmetric space $G(\mathbb R)/K_\infty$ (when $k=\mathbb Q$). There are some comments to that extent in \cite{Borel-Ji}, who also give another description of essentially the same compactification, following Furstenberg and Satake, which illuminates the role of the degenerations $[G]_P$ in harmonic analysis. This is the ``closed subgroups'' compactification: namely (in classical language now, with a lattice $\Gamma\subset G(\mathbb R)$, under the mild assumption that $\Gamma$ is self-normalizing in $G(\mathbb R)$, one can think of the quotient $\Gamma\backslash G(\mathbb R$) as embedded in the space of closed subgroups of $G(\mathbb R)$, which has a natural, compact, Hausdorff topology (see Proposition 5.2 in that paper). Then, one can take the closure; the boundary components, i.e., the ``limits'' of the conjugacy class of $\Gamma$, are the stabilizers for the boundary degenerations $[G]_P$. 
\end{remark}


\begin{lemma}
 \label{lemma-manifold-corners}
Assume that $k=\mathbb Q$, and let $K\subset G(\mathbb A_f)$ be a compact open subgroup. The space $\overline{A_P(\mathbb R)^0} \times^{A_P(\mathbb R)^0} [G]_P/K$ has the structure of a manifold with corners, so that the quotient $\overline{A_P(\mathbb R)^0} \times [G]_P/K \to \overline{A_P(\mathbb R)^0} \times^{A_P(\mathbb R)^0} [G]_P/K$ is an ${A_P(\mathbb R)^0}$-torsor in manifolds with corners. 
\end{lemma}

\begin{proof}
 The space $[G]_P/K$, under the $G(\mathbb R)$-action, is a union of homogeneous manifolds, and the space $\overline{A_P(\mathbb R)^0}$ is a manifold with corners (isomorphic to a product of copies of $\mathbb R_{>0}$ and $\mathbb R_{\ge 0}$) . The stabilizer for the action of $A_P(\mathbb R)^0$ on it is a compact subgroup, hence trivial, and therefore the quotient of $\overline{A_P(\mathbb R)^0} \times [G]_P/K$ by the action of $A_P(\mathbb R)^0$ inherits the structure of a manifold with corners.
\end{proof}

There is some coarser topology than the manifold topology that these spaces have, in the number field case, namely some sort of ``semialgebraic'' topology. This plays a role in harmonic analysis; we will return to it when appropriate.

Finally, we introduce the notion of the cusp:
\begin{definition}
 \label{definition-P-cusp}
 Consider a standard embedding $[G]_P \subset \overline{[G]_P}$, as in Definition \ref{definition-standard-embedding}. The {\it $P$-cusp} in $\overline{[G]_P}$ is the closed $G(\mathbb A)$-orbit. A {\it neighborhood of the $P$-cusp} in $[G]_P$ is the intersection of $[G]_P$ with a neighborhood of the $P$-cusp in $\overline{[G]_P}$. When $P$ is the class of minimal parabolics, the $P$-cusp will simply be called ``the cusp''. 
\end{definition}

Notice that the distinction ``$P$-cusp'', as opposed to ``cusp'', is important: e.g., when $P=G$, the partial compactification $\overline{[G]}$ above is trivial, so the $G$-cusp is $[G]$ itself, but there will be a ``cusp'', which, to define, we first need to discuss reduction theory, and a full compactification. 

\begin{lemma}
\label{lemma-definitions-cusp-equivalent}
All standard embeddings of Definition \ref{definition-standard-embedding} give rise to the same neighborhoods of the $P$-cusp.
\end{lemma}


\begin{proof}
This relies on the ``baby case'' of the partial compactification $\mathbb G_m\hookrightarrow \mathbb G_a$. We leave the rest to the reader.


 \begin{quote}
Under the natural map 
$$ k_\infty \times^{k_\infty^\times} [\mathbb G_m] \to \mathbb A \times^{\mathbb A^\times} [\mathbb G_m] = \mathbb A/k^\times,$$
a basis of neighborhoods of the ``cusp'' (represented by $0\in \mathbb A$) on the right hand side maps to a basis of neighborhoods of the ``cusp'' (represented by $0\in k_\infty$) on the left hand side.
\end{quote}

The map is continuous, so it is enough to show that any element in a basis of neighborhoods $(V_r)_r$ on the left contains the preimage of a neighborhood on the right. Since the cusp is invariant under $[\mathbb G_m]$, and in particular under the compact subgoup $K=[\mathbb G_m]^1$, we can take the basis on the left to be invariant under $K$, and then it is seen that the sets $V_r = \{ x\in [\mathbb G_m], |x|<r\}$  with $r\to 0^+$ form such a basis. If we choose an adele $b$ with $|b|<r$, and let $V'$ be the union of $k^\times$-translates of the set $\{a \in \mathbb A, \forall v:  |a_v|\le |b_v|\}$, then $V'$ is open, and its preimage belongs to $V_r$. This proves the claim. 

\end{proof}




\begin{remark}
 \label{remark-cusp-Iwasawa}
Let us explicate neighborhoods of the cusp in the case where $G$ is split, hence the minimal parabolic is a Borel subgroup. (A similar description will be valid for the minimal parabolic $P$ in every case, once we show --- Theorem \ref{theorem-reduction-theory-general} --- that $[L']$ is compact, where $L'$ is the derived subgroup of the Levi quotient of $P$.) 

Choose a Borel subgroup $B=AN$, and a maximal compact subgroup $K$ of $G(\mathbb A)$ which satisfies the Iwasawa decomposition $G(\mathbb A) = B(\mathbb A)K$. 
 Then, for \emph{any} identification $\bar Y = N\backslash G$ over $k$, a basis of neighborhoods of the cusp in $[G]_B$ is given by the neighborhoods $V_\epsilon := N(\mathbb A)[A]^{\le \epsilon}  K$ (as $\epsilon\to 0^+$), where $[A]^{\le \epsilon}$ is the set of elements $a$ with $|e^\alpha(a)|\ge \epsilon^{-1}$ for all positive roots $\alpha$. 
\end{remark} 

We reformulate the definition of the $P$-cusp, when the last choice of standard embedding in Definition \ref{definition-standard-embedding} is made: Let $Y$ be the pre-flag variety $U\backslash G$. The action of $A_P$ by $G$-automorphisms allows us to define a (so-called \emph{toroidal}) partial compactification $\bar Y\supset Y$, as $\bar Y = \overline{A_P} \times^{A_P} Y$, where $\overline{A_P}$ is the affine embedding defined by the wall of the (semisimple) antidominant chamber, as above. In particular, $\bar Y$ contains a closed $G$-orbit $Y_0$, which we will call \emph{the $P$-cusp in $\bar Y$}. Now, consider an $\text{Aut}^G(Y)(k)$-stable neighborhood $V$ of $Y_0(\mathbb A)$ in $\bar Y(\mathbb A)$ --- recall that $\text{Aut}^G(Y)$ is identified with the Levi quotient of $P$, once we fix a point whose stabilizer is the unipotent radical of $P$. Notice also that $Y(\mathbb A)$ is not open in $\bar Y(\mathbb A)$ --- but it doesn't matter! All that matters is the subset $\bar Y(k)G(\mathbb A)$ of ``primitive'' elements, where $Y(\mathbb A)$ is open.

Now recall from Definition \ref{definition-boundary-degeneration} that $[G]_P$ is defined as the set of pairs $(M,y)$ modulo $\text{Aut}^G(Y)(k)$, where $M$ is a $G(\mathbb A)$-translate of $Y(k)$, and $y\in M$. Let $\tilde V\subset [G]_P$ be the subset given by the condition $y\in V$. Then, the neighborhoods of the $P$-cusp in $[G]_P$ are precisely the sets of the form $\tilde V$, where $V$ is an $\text{Aut}^G(Y)(k)$-invariant neighborhood of the $P$-cusp in $\bar Y$, and $\tilde V$ is obtained from $V$ as above.



We will now modify this description to define a degenerate version of the $P$-cusp, that leads to a coarser collection of ``neighborhoods of infinity''. Let $Y_{deg}$ be the degenerate pre-flag variety $[P,P]\backslash G$. Again, the action of $A_P$ by $G$-automorphisms allows us to define a partial compactification $\bar Y_{deg}\supset Y_{deg}$, as $\bar Y_{deg} = \overline{A_P} \times^{A_P} Y_{deg}$, where $\overline{A_P}$ is the affine embedding defined by the wall of the (semisimple) antidominant chamber, as above. In particular, $\bar Y_{deg}$ contains a closed $G$-orbit $Y_{deg,0}$, which we will call \emph{the degenerate $P$-cusp in $\bar Y_{deg}$}. Now, consider an $L^{ab}(k)$-stable neighborhood $V_{deg}$ of $Y_{deg,0}(\mathbb A)$ in $\bar Y_{deg}(\mathbb A)$, where $L^{ab}$ is the abelianization of $L=\text{Aut}^G(Y)$.

Using again Definition \ref{definition-boundary-degeneration} for $[G]_P$ as the set of pairs $(M,y)$ modulo $\text{Aut}^G(Y)(k)$, we let $\tilde V\subset [G]_P$ be the subset given by the condition $\bar y\in V_{deg}$, where $\bar y$ is the image of $y$ under $U\backslash G\to [P,P]\backslash G$. In other words, these are neighborhoods of the cusp obtained from neighborhoods $V\subset U\backslash G(\mathbb A)$, as before, except that $V$ should be stable under the commutator of the Levi. 

\begin{definition}
 \label{definition-degenerate-P-cusp}
 A {\it neighborhood of the degenerate $P$-cusp} in $[G]_P$ is a set of the form $\tilde V$ as above, where $V$ is a neighborhood of the degenerate $P$-cusp in $\bar Y_{deg}(\mathbb A) = \overline{[P,P]\backslash G}(\mathbb A)$.
\end{definition}

Hence, a neighborhood of the degenerate $P$-cusp in $[G]_P$ is a neighborhood of the $P$-cusp, but a neighborhood of the $P$-cusp is a neighborhood of the degenerate $P$-cusp only when it is the preimage of a set under the map 
$$ L(k)U(\mathbb A)\to G(\mathbb A) \to L^{ab}(k)[P,P](\mathbb A)\backslash G(\mathbb A).$$
Of course, the two notions coincide when $P$ is in the class of Borel subgroups.

\section{Adelic heights, and the case of $\text{SL}_2$}
\label{section-adelic-heights}


\begin{definition}
 \label{definition-adelic-height}
An \emph{adelic height} on a vector space $V$ over $k$ is a function of the form $\Vert x\Vert = \prod_v \Vert x_v \Vert_v$ on $V(\mathbb A)$, where:
\begin{itemize}
 \item $\Vert \bullet \Vert_v$ is a norm on $V(k_v)$, i.e., a subadditive, $\mathbb R_{\ge 0}$ valued function that is zero only at $0$ and satisfies $\Vert a x \Vert_v = |a|_v \cdot \Vert x \Vert_v$ for every $a\in k_v$, $x\in V(k_v)$;
 \item there is a basis of $V$ over $k$ such that for almost every non-Archimedean place, $\Vert x\Vert_v$ is the maximum of the absolute values of the coordinates of $x$ in that basis.
\end{itemize}
\end{definition}

Obviously, the factors of the product are almost all equal to $1$ if $x\in (V\smallsetminus\{0\})(\mathbb A)$, but the height extends continuously by zero to the entire space $V(\mathbb A)$ (though we will never use that).


\begin{lemma}
 \label{lemma-height-functions}
Adelic height functions (Definition \ref{definition-adelic-height}) on a vector space $V$ have the following properties:
\begin{enumerate}
 \item For any two height functions $\Vert \bullet \Vert'$, $\Vert\bullet\Vert''$, the quotient $\frac{\Vert\bullet\Vert'}{\Vert\bullet\Vert''}$ is bounded above and below by positive numbers.
 \item For all $a\in \mathbb A^\times$, $x\in V(\mathbb A)$, we have $\Vert a x \Vert = |a|\cdot \Vert x \Vert$; in particular, $\Vert \bullet \Vert$ is invariant under $k^\times$-multiplication.
 \item The restriction of $\Vert\bullet\Vert$ to the quotient space $k^\times \backslash V(k)\cdot \text{GL}_V(\mathbb A) = k^\times\backslash (V^*(\mathbb A)\cup \{0\})$, where $V^*$ denotes the complement of zero, defines a basis of neighborhoods of zero.
 \item For every $g\in \text{GL}_V(\mathbb A)$ and any $c>0$, there is only a finite number of classes $[y]\in k^\times \backslash V(k)$ such that $\Vert y\Vert <c$; in particular, the set $\Vert V^*(k)g\Vert$ has a minimum.
\end{enumerate}

\end{lemma}

\begin{proof}
 Left to the reader.
\end{proof}


Let us now discuss the case of $G=\text{SL}_2$, with its standard representation $V$. Notice that $V^*=V\smallsetminus\{0\}$ can be identified with the pre-flag variety $Y$ for the class of Borel subgroups of $G$ (Definition \ref{definition-pre-flag}), and $V$ is simply its affine closure, i.e., $V= \text{Spec} k[Y]$. In this case, the cusp can also be defined with the help of the affine embedding $V$, instead of the toroidal embedding $\bar Y$. That is, instead of choosing a $k^\times$-invariant neighborhood of the cusp $U$ in $\bar Y(\mathbb A)$, one can choose a $k^\times$-invariant neighborhood $U$ of zero in $V(\mathbb A)$, and pull it back to $B(k)\backslash G(\mathbb A)$ to define a neighborhood of the cusp there. By Lemma \ref{lemma-height-functions}, a basis of such neighborhoods of zero is determined by height functions.


\begin{remark}
 \label{remark-basic-affine}
We caution the reader that, in higher rank, the affine embedding $\bar Y^{\text{aff}}=\overline{N\backslash G}^{\text{aff}} = \text{Spec} k[N\backslash G]$ (where $G$ is assumed split semisimple, and $N$ is a maximal unipotent subgroup) is \emph{not} the appropriate space to define the cusp, i.e., not every neighborhood of the cusp in $[G]_B$ is the pullback of an $A(k)$-invariant neighborhood of ``zero'' (=the unique $G$-fixed point) in $Y^{\text{aff}}(\mathbb A)$. 

In terms of toric varieties, this is because the toroidal embedding of $Y$ used in the definition of the $P$-cusp corresponds to the antidominant Weyl chamber, while the affine closure $Y^{\text{aff}}$ corresponds to the \emph{negative root cone}, in the sense that it admits a blowup $\tilde Y \to \bar Y^{\text{aff}}$, with $\tilde Y = \tilde A\times^A Y$, and $\tilde A$ is the affine embedding of $\tilde A$ corresponding to the negative root cone. Thus, $A(k)$-invariant neighborhoods of zero in $Y^{\text{aff}}(\mathbb A)$ are \emph{much larger} than neighborhoods of the cusp, in higher rank, and the latter cannot be defined using adelic heights on an affine embedding of $Y$.
\end{remark}

Now, we formulate the main theorem of reduction theory for $G=\text{SL}_2$:

\begin{theorem}
 \label{theorem-reduction-SL2}
Let $G = \text{SL}_2$, and consider the maps 
\begin{equation}
\label{equation-leftrightSL2} 
\xymatrix{
& B(k)\backslash G(\mathbb A) \ar[dl]_{\pi_G}\ar[dr]^{\pi_B}& \\
[G] && [G]_B. 
}\end{equation}
Fix an adelic height function $\Vert \bullet \Vert$ (Definition \ref{definition-adelic-height}) on the space $V$ of the standard representation of $G$, and for every $\epsilon >0$, let $U_\epsilon$ be the preimage in $[G]_B$ of the set of points $y\in Y(\mathbb A)$ (where $Y=V^*=V\smallsetminus\{0\}$) with $\Vert y \Vert <\epsilon$, and $\tilde U_\epsilon$ its preimage in $B(k)\backslash G(\mathbb A)$.

Then, for $\epsilon$ sufficiently small, the map $\pi_G|_{\tilde U_\epsilon}$ is injective, while for $\epsilon$ sufficiently large, $\pi_G|_{\tilde U_\epsilon}$ is surjective. In particular, for every $\epsilon$, the complement of $\pi_G({\tilde U_\epsilon})$ is relatively compact in $[G]$.
\end{theorem}

\begin{proof}
 Injectivity: It suffices to show that, if $\epsilon$ is sufficiently small, for any $g\in G(\mathbb A)$ the set $\{y \in Y(k)g| \Vert y\Vert <\epsilon\}$ contains at most one $k^\times$-orbit.
 
 Hence, fix $[g]\in [G]$, and let us also fix the point $y_0 =(0,1)\in Y$, so that its image in the flag variety is stabilized by the upper triangular Borel subgroup $B$. Let us fix a good maximal compact subgroup $K$ that satisfies the Iwasawa decomposition $G(\mathbb A) = B(\mathbb A)K$, and we may without loss of generality assume that the adelic norm $\Vert \bullet \Vert $ is $K$-invariant. Assume that $y\in Y(k)g$ has height $<\epsilon$. We may choose a representative $g\in G(\mathbb A)$ for $[g]$ such that $y = y_0 g$.  
 Writing $g = bk$ according to the Iwasawa decomposition, we have $ b = \begin{pmatrix} a & r \\ & a^{-1}\end{pmatrix}$, and $ \Vert y_0 g\Vert = \Vert y_0 b\Vert = \Vert a^{-1} y_0\Vert = |a|^{-1} \Vert y_0\Vert$, so $|a| > \epsilon^{-1} \Vert y_0\Vert$. 
 
 Our goal is to show that, if $\epsilon$ is sufficiently small (independently of $[g]$), any other element $z\in Y(k)g$ with height $<\epsilon$ is a $k^\times$-multiple of $y$. If not, we have $z = z_0 g$ with $z_0 = (\kappa, \lambda) \in k^2$ with $\kappa\ne 0$. Up to the $k^\times$-action, we may assume that $\kappa=1$. But $\Vert z_0 g\Vert = \Vert z_0 b\Vert$, and $\Vert z_0 b\Vert = \Vert (a , r + a^{-1} \lambda)\Vert$. It is now clear from the definition of heights that if $\epsilon$ is sufficiently small, so that $|a|$ is sufficiently large, the last expression is $>\epsilon$.
 
 (For a more geometric, and conceptual, version of the same argument, see the proof of the general case in Theorem \ref{theorem-reduction-theory-split}.)
 
 Surjectivity: Vice versa, it suffices to show that if $\epsilon$ is large enough, then for every $[g]\in [G]$ the set $\{y\in Y(k)g | \Vert y\Vert >\epsilon\}$ is nonempty. Given $[g]$, we may choose a representative $g\in G(\mathbb A)$ so that $\Vert y_0 g\Vert$ is minimal in $\Vert Y(k)g\Vert$. (The minimum exists, by Lemma \ref{lemma-height-functions}.) Write $g = bk$ by the Iwasawa decomposition, where $b = \begin{pmatrix} a & r \\ & a^{-1}\end{pmatrix}$. The minimality of $\Vert y_0 g\Vert$ implies that 
 $\Vert (a , r + a^{-1} \lambda)\Vert \ge \Vert y_0 g\Vert = |a|^{-1} \Vert y_0 \Vert$ for all $\lambda\in k$, hence $|a|^2 \ge \frac{\Vert y_0\Vert }{\Vert (1 , a^{-1} r + a^{-2} \lambda)\Vert}$. The denominator is bounded away from zero, giving a lower bound for the absolute value of the positive root $|e^\alpha(b)| = |a|^2$, and an upper bound for $\Vert y_0 g\Vert = |a|^{-1} \Vert y_0 \Vert$. Hence, if $\epsilon$ is larger than this upper bound, the class of $[g]$ is represented in $\tilde U_\epsilon$.
 
 
\end{proof}





\section{Reduction theory and compactifications in the split case}
\label{section-reduction-theory-split}

Reduction theory is the description of the space $[G]$ ``at infinity'' in terms of its boundary degenerations. 
In this section, we will prove the main result of reduction theory in the split case. We will use it to define a certain compactification of $[G]$, which will be used in the next section to address the general case.

Before we generalize from $\text{SL}_2$ to the general case, we need a purely algebro-geometric result on closure of horocycles on pre-flag varieties. The result is analogous to the following statement in the case of $\text{SL}_2$: Let $N\subset \text{SL}_2$ be the stabilizer of a nonzero vector on the two-dimensional plane, let $\ell$ be the line spanned by that vector, and let $\ell'$ be a different, affine line parallel to $\ell$; notice that $\ell'$ is an $N$-orbit. Let $v_n \in \ell'$ be a sequence of points such that the lines that they span approach $\ell$ in the projective space; the statement is that $v_n\to \infty$. This fact is obvious in this case, or for any unipotent orbit on a quasiaffine space, since by a result of Rosenlicht \cite{Rosenlicht-quotient-varieties} orbits of unipotent groups on affine spaces are closed. Here, however, we need finer information for the quasiaffine space $Y=N\backslash G$ in higher rank: Roughly speaking, we need to know that if a point is far from the cusp, so is its entire $N$-orbit. Since the cusp cannot be described in terms of affine embeddings in higher rank (see Remark \ref{remark-basic-affine}), we need to consider more general compactifications, and Rosenlicht's theorem will not be enough.

Let $Y=N\backslash G$ be ``the'' pre-flag variety for $G$. In order to keep track of possible limits in various directions, let us consider a full compactification $\bar A^F$ of the torus $A$, described by a fan $F$ whose support is the entire space $\mathfrak a$. Let $\bar Y^F = \bar A^F \times^A Y$ --- it is a proper variety over the flag variety $\mathcal B$.

Choose a Borel subgroup $B\in \mathcal B(k)$, and a section of the canonical map $B\to A$, and denote its image by $T$; hence, $T$ is a maximal torus in $B$, identified with $A$ through the quotient map. We use $\bar T$, $\bar T^F$ etc.\ for $T$, as for $A$. For every $B'\in \mathcal B$ and any strictly antidominant cocharacter $\lambda$ into $T$, we have $\lim_{x \to 0} B'^{\lambda(x)} = B^w$, for some $w$ in the Weyl group of $W$ --- this is the Bruhat decomposition!  


The following proposition is very essential in what follows; although purely of algebrogeometric nature, it will enventually translate to information about the ``heights'' of points on $N$-orbits on the preflag variety. This information is useful not only for reduction theory, but also for the study of Radon transforms and intertwining operators.


\begin{proposition}
\label{proposition-horocycle-closures}
Let $Y\to \mathcal B$ be the preflag variety of a reductive group $G$, $y_0, y' \in Y$ be two points lying over Borel subgroups $B$, $B'$, let $T\subset B$ be a maximal torus, and assume that $y' \in  y_0 \tilde w N$, where $N\subset B$ is the unipotent radical, and $\tilde w$ is an element in the normalizer of $T$. 
\begin{enumerate}
 \item Let $\bar Y^F = \bar A^F\times^A Y \to \mathcal B$ be the fiberwise compactification of $Y$ determined by the fan of all Weyl chambers. If $\lambda:\mathbb G_m\to T$ is a strictly antidominant cocharacter with respect to $B$, then $\lim_{x\to 0} y' \lambda(x) \in \bar Y^F$ is the $A$-fixed point in the fiber over $B^w \in \mathcal B$ which corresponds to the right-$w$ translate of the antidominant cone in $\mathfrak a$. 

 \item Let $\bar A^{R(w^{-1})^+}$ be the embedding of $A$ corresponding to the cone $R(w^{-1})^+$ spanned by the positive coroots $\check\gamma$ such that $w^{-1}\check\gamma <0$, and let $\bar Y^{R(w^{-1})^+}$ be the corresponding embedding of $Y$, so that $G$-orbits on $\bar Y^{R(w^{-1})^+}$ (or, equivalently, $A$-orbits in each fiber over the flag variety) correspond to faces of the cone $R(w^{-1})^+$. 
 Then, the closure of $y_0 \tilde w N$ in $\bar Y^{R(w^{-1})^+}$ is proper, and the points in the boundary of $y_0 \tilde w N$ lie in the complement of the open $G$-orbit. 

\end{enumerate}
\end{proposition}

\begin{proof}
 The first statement is not needed for what follows, and is left to the reader.

Let us prove the second statement: First, fix any compacification $\bar Y^F =\bar A^F \times^A Y$, so that the closure of $y_0 \tilde w N$ in $\bar Y^F$ is proper. This closure corresponds to the closure of the set $A\cdot (1,y_0\tilde w N)$ in $\bar A^F \times Y$, where $A$ acts by $a\cdot (x,y) = (a^{-1} x, a y)$. 

Let $Y_w\subset Y$ be the preimage of the closed Schubert cell $S_w:=\overline{B\backslash B w N}$. We write $\mathring S_w$, $\mathring Y_w$ for the corresponding open Schubert cell and its preimage, and identify the (``geometric'') quotient of $\mathring Y_w$ by $N$ with $A$, equivariantly under the right action of $B=A/N$, by fixing the base point $\overline{y_0\tilde w}$=the image of $y_0\tilde w$. Notice that this is \emph{not} the equivariant identification with respect to the canonical action of $A$ on $Y$.
The complement of $\mathring S_w$ in $S_w$ is a union of Schubert divisors $S_{w'}$ with $w' = w w_\gamma$ for some (not necessarily simple) root $\gamma$ and length $\ell(w') = \ell(w)-1$. The coordinate ring $k[Y_w]^N$ is generated by those characters of $A$ which, considered as functions on $\mathring Y_w$, have $\ge 0$ valuations on the corresponding divisors $Y_{w'}$. We claim that these are the characters which are $\ge 0$ on the cone $R(w)^+$ spanned by the positive coroots $\check\gamma$ such that $w\check\gamma <0$. Indeed, consider a reduced decomposition $w= w_{\alpha_1} w_{\alpha_2} \cdots w_{\alpha_n}$ into simple reflections, and work on the corresponding Bott--Samelson resolution of $S_w$: $\tilde S_w = B\backslash P_{\alpha_1} \times^B P_{\alpha_2} \times^B \cdots \times^B P_{\alpha_n}$, and the corresponding resolution $\tilde Y_w$ of $Y_w$ (divide by $N$ on the left instead of by $B$). Each codimension-one divisor $S_{w'}$ is the image of the subset $\tilde S_{w'}\subset \tilde S_w$ obtained by omitting a factor $P_{\alpha_i}$. Is is easy to see that the divisor $N\backslash B$ induces the valuation $\left<\check\alpha_i, \chi\right>$ on $B$-eigenfunctions with character $\chi$ on $N\backslash P_\alpha$, and therefore $\tilde Y_{w'}$ induces the valuation $\left<\check\gamma, \chi\right>$ on $B$-eigenfunctions on $\tilde Y_w$, where $\check\gamma = w^{-1}\check\alpha_i$. These are precisely the positive coroots such that $w\check\gamma <0$. Thus, the regular characters are those which are $\ge 0$ on $R(w)^+$. 


Thus, $Y_w\sslash N \simeq \bar A^{R(w)^+}$, the embedding of $A$ corresponding to the cone $R(w)^+$, equivariantly under the right action of $A=B/N$. If instead we use the (``left'') action of $A$ on $Y$, we identify this space with the embedding $\bar A^{w\cdot R(w)^+}$.
Passing to the corresponding quotient of $\bar A^F \times Y_w$,  the closure of $A\cdot (1,y_0\tilde w N)$ maps to the closure of $A\hookrightarrow \bar A^F \times \bar A^{w R(w)^+}$, where the embedding is the antidiagonal one. Notice that $w R(w)^+ = -R(w^{-1})^+$.
If we now assume that $\bar A^F$ contains $\bar A^{R(w^{-1})^+}$ as an open subset, we see that the closure of $A\hookrightarrow \bar A^F \times \bar A^{wR_{w}^+}$ maps into $\bar A^{R(w^{-1})^+}$ under the projection to the first factor. This proves the properness of the closure of $y_0 \tilde w N$ in $\bar Y^{R(w^{-1})^+}$. Moreover, the proof shows that a point in the boundary of this set, hence lying over a non-open orbit of $Y_w\sslash A$, will project to the complement of the open $A$-orbit in $A^{R(w^{-1})^+}$. 
\end{proof}




Fix a class $\mathcal P$ of parabolics, and a parabolic $P\in \mathcal P(k)$. (Nothing will depend on $P$, but it is notationally convenient.)
Consider the homogeneous space $\mathcal P(k)\times^{G(k)} G(\mathbb A) = P(k)\backslash G(\mathbb A)$, already encountered in Remark \ref{remark-bdrydegen-as-induction}. It admits a pair of quotient maps:
\begin{equation}
\label{equation-leftright} 
\xymatrix{
& P(k)\backslash G(\mathbb A) \ar[dl]_{\pi_G}\ar[dr]^{\pi_P}& \\
[G] && [G]_P,
}\end{equation}
and notice that $\pi_G$ is a local homeomorphism, while $\pi_P$ has compact fibers.


We will call ``neighborhood of the (degenerate) $P$-cusp'' in $P(k)\backslash G(\mathbb A)$ the preimage of any neighborhood of the (degenerate) $P$-cusp in $[G]_P$. Generally, for a neighborhood $V$ of the $P$-cusp in $[G]_P$, we will use the notation $\tilde V$ for its preimage in $P(k)\backslash G(\mathbb A)$. Recall that the $P$-cusp is a $G(\mathbb A)$-orbit in a certain partial compactification $\overline{[G]_P}$ of $[G]_P$, see Definition \ref{definition-P-cusp}. A ``scaling'' of such a neighborhood will be the neighborhood that we obtain from it by the action of an element $a\in A_P(\mathbb A)$ on $[G]_P$.


\begin{theorem}
 \label{theorem-reduction-theory-split}
Let $G$ be a split reductive connected group over $k$, and $P\subset G$ a (class of) parabolic(s).
 \begin{description}
  \item[(I)] Every compact subset of the $P$-cusp in $\overline{[G]_P}$ has a neighborhood $V$ such that $\pi_G|_{\tilde V}$ is injective, where $\tilde V$ is the preimage of $V$ in $P(k)\backslash G(\mathbb A)$.\footnote{Obviously, ``every compact subset'' is superfluous, but we include it to stress that there is no uniformity in the choice of neighborhood.}
  \item[(S)] Every $[A_G]$-invariant neighborhood of the degenerate $P$-cusp in $[G]_P$ (where $A_G$ is the maximal split torus in the center of $G$) can be scaled to a neighborhood $V$ such that $\pi_G|_{\tilde V}$ is surjective, where $\tilde V$ is as above. 
 \end{description}
\end{theorem}


\begin{proof}
There are two approaches to proving this theorem: One, due to Borel and Harish-Chandra \cite{Borel-HC}, is to prove it first for $\text{GL}_n$ over $\mathbb Q$, and then deduce it for a general reductive group via an embedding $G\to \text{GL}_n$ (where $G$, by restriction of scalars, can be considered as a group over $\mathbb Q$, at least in the number field case. Here and in the next section, we will present the second, following Godement \cite{Godement-domaines-fondamentaux} and Springer \cite{Springer-reduction-theory}, but heavily reformulated. [We caution that there are serious gaps in both Godement and Springer, especially at the point that corresponds to Proposition \ref{proposition-horocycle-closures}.]

Having addressed the case of split tori in Proposition \ref{proposition-automorphic-Gm}, we will now assume that $G$ is semisimple; the combination of the two to address the general case is ``easy'', and left to the reader. 



The proof of (I) relies on Proposition \ref{proposition-horocycle-closures}.  Fix the base point $y_0\in Y(k)$, and let $B$ be the stabilizer of its $A$-orbit. Fix a maximal compact subgroup satisfying the Iwasawa decomposition $G(\mathbb A) = B(\mathbb A) K$. We use this, together with the logarithmic maps $B(\mathbb A)\to \mathfrak a$, defined as in \eqref{equation-logmap}, to define a {\it Harish-Chandra function}  on $[G]_B = A(k)\backslash y_0 G(\mathbb A)$:
$$H(g) = \log(b)\in \mathfrak a.$$ 
This is similar to the height functions of Definition \ref{definition-adelic-height}, except that it does not use an affine embedding of $Y$; rather, the sets $V_\epsilon = \{ [g] \in [G]_B| \left < \alpha, H(g) \right > > -\log \epsilon \,\, \mbox{ for all positive roots } \alpha\}$ form a basis of neighborhoods for the cusp. (See Remarks  \ref{remark-cusp-Iwasawa} and \ref{remark-basic-affine}.)

We claim that the statement of Proposition \ref{proposition-horocycle-closures} about the closure of $y_0 \tilde w N$ implies the following:

\begin{itemize}
 \item There is a compact $C_0\subset \mathfrak a$ such that 
\begin{equation}
 \label{equation-bound-height}
H(y_0 \tilde w N(\mathbb A)) \subset C_0 - R(w^{-1})^+.
\end{equation}
\end{itemize}
[We leave it to the reader to check this corollary, for now. We remark only that the embedding of $N\backslash G$ which corresponds to the cone $R(w^{-1})^+$ is the one where, for a cocharacter $\lambda\in R(w^{-1})^+$ into the torus $A$, and a point $y\in N\backslash G$, the limit of $\lambda(t)\cdot y$ exists \emph{as $t\to 0$}; the logarithm of such an element $\lambda(t)$, for $t$ close to zero, belongs to the \emph{negative} of the cone $R(w^{-1})^+$, hence the negative sign above.]


Returning to the proof of (I), consider the surjective maps 
$$B(k)\backslash G(\mathbb A)\xrightarrow{\pi^B_P} P(k)\backslash G(\mathbb A) \xrightarrow{\pi_G} [G],$$ 
for any parabolic $P\supset B$. Fix a compact $\Omega\subset [G]_P$, and consider the subsets $\Omega_\epsilon= [A_P]_\epsilon \cdot \Omega$, where $[A_P]_{\epsilon}$ is the set of elements $a$ with $\left< \alpha,\log(a)\right> > -\log \epsilon$ for every simple root $\alpha$ in the unipotent radical of $P$; recall that $\log(a)\in\mathfrak a_P$, for $a\in A_P(\mathbb A)$. These subsets form a basis of neighborhoods of the image of $\Omega$ in the $P$-cusp as $\epsilon\to 0$ (which, by abuse of notation, we will denote by $A_P\backslash \Omega$). In turn, $\Omega$ is contained in the image $\Omega'$ of a compact subset of $B(k)\backslash G(\mathbb A)$ under $B(k)\backslash G(\mathbb A)\to P(k)\backslash G(\mathbb A) \to [G]_P$. Thus, we see
\begin{itemize}
 \item There is a countable basis of neighborhoods in $[G]_P$ of the subset $A_P\backslash \Omega$ of the $P$-cusp which, for any $\lambda_0\in \mathfrak a_P$, is eventually contained in  the image of a set of the form $h^{-1} (C+\lambda_0 + \mathfrak a_P^+)\subset B(k)\backslash G(\mathbb A)$ under the map $\pi^B_P$ above, where $C$ is a fixed compact subset depending on $\Omega$. 
\end{itemize}

Thus, to prove (I), it suffices to show that, if $\lambda_0$ is sufficiently dominant (i.e., sufficiently deep in the relative interior of $\mathfrak a_P^+$), any two elements $g, g'\in B(k)\backslash G(\mathbb A)$ with $H(g), H(g')\in C+\lambda_0 + \mathfrak a_P^+$ and the same image in $[G]$, have the same image in $P(k)\backslash G(\mathbb A)$. In other words, we need to show that if $y = y_0 \tilde w \nu$ for $\tilde w\in \mathcal N(T)(k)$ and $\nu\in N(k)$, and $y g = y_0 g'$ for two elements as above, then $y \in  y_0 L(k)$. 

Now, on one hand, $H(y_0g) = H(g)$ and $H(y g) = H(y_0 g') =  H(g')$ belong to $C+\lambda_0 + \mathfrak a_P^+$, by assumption. On the other, writing $g = n t k$ according to the Iwasawa decomposition, we have $H(y_0g) = H(t)$ and $H(yg) = H(y_0 \tilde w \nu ntk) \in H(y_0 {^wt} \tilde w N(\mathbb A))$. By \eqref{equation-bound-height}, which translates in the obvious way under the action of $A$, we obtain $H(y_0 {^wt} \tilde w N(\mathbb A)) \subset C_0 + H({^wt}) - R(w^{-1})^+ \subset C_0 + wC+ w\lambda_0 + w\mathfrak a_P^+ + w R(w)^+$. 
Thus, it suffices to show that the intersection
\begin{equation}
\label{equation-intersection-cones}
(C+\lambda_0 + \mathfrak a_P^+) \cap  (C_0 + wC+ w\lambda_0 + w\mathfrak a_P^+ +w R(w)^+)
\end{equation}
is empty for sufficiently large $\lambda_0$ (i.e., sufficiently deep in the interior of $\mathfrak a_P^+$), unless $w$ preserves $\mathfrak a_P^+$, that is, unless $\tilde w\subset P(k)$. 

Write $\mathcal C$ for the cone $-R(w^{-1})^+=wR(w)^+$. As a first hint for the proof, notice that, because $\lambda_0 \in \mathfrak a_P^+$ is dominant, the difference $w\lambda_0 -\lambda_0$ lies in $\mathcal C$. If this difference is nonzero, i.e., if $w$ does not preserve $\lambda_0$ (equivalently, does not preserve the face $\mathfrak a_P^+$), then by a simple scaling argument the difference can be made to avoid any compact set, by taking $\lambda_0$ large enough, so that $(C+\lambda_0) \cap  (C_0 + wC+ w\lambda_0 + \mathcal C) = \emptyset$.

To show the stronger statement that, for such $w$, the intersection \eqref{equation-intersection-cones} is empty, it suffices to prove that the intersection 
$$ {\mathfrak a}^+ \cap  (w\mathfrak a^+ + \mathcal C)$$
does not meet the relative interior of $\mathfrak a^+$. (In fact, the argument will show that the intersection consists precisely of those faces of $\mathfrak a^+$ which are fixed by $w$, i.e., are orthogonal to $\mathcal C$.) To see this, let $R^\pm$ denote the positive and negative root cones, and notice that $\mathcal C$ is equal to $wR^+\cap R^-$. Let $\mathcal C^\vee$ denote the dual cone of all elements of $\mathfrak a$ that are $\ge 0$ on $\mathcal C$ (under one, equivalently any, $W$-invariant positive definite quadratic form). Then $w\mathfrak a^+ \subset \mathcal C^\vee$, while $\mathfrak a^+\subset -\mathcal C^\vee$. Therefore, $ {\mathfrak a}^+ \cap  (w\mathfrak a^+ +\mathcal C )\subset  -\mathcal C^\vee \cap (\mathcal C +\mathcal C^\vee) = \mathcal C^\perp$.







This proves (I).

 
Now we come to the proof of (S). It is enough to prove it for the minimal parabolic (i.e., the Borel). The cusp of $\overline{[G]_B}$ is isomorphic to $\mathcal B(\mathbb A)$, hence compact. Fix an ordering $\alpha_1, \alpha_2, \dots,\alpha_r$ of the simple roots in the root system of $G$, and let $P_i$ be the parabolic which contains $\alpha_j$ with $j\le i$ in its unipotent radical, and $\alpha_j$ with $j>i$ in its Levi. Hence, $P_0=G$ and $P_r=B$. For each $i$, fix a (right) representation $V_i$ and a vector $v_i \in V_i(k)$ such that $v_i$ is an eigenvector for $P_i$, but no larger parabolic. Fix adelic heights on the $V_i$'s, and consider the set 
 $$ \Omega = \{g \in B(k)\backslash G(\mathbb A) | \forall i \ge 1, \forall \gamma \in P_{i-1}(k), \Vert v_i \gamma g \Vert \ge \Vert  v_i g\Vert\}.$$
 Then, by the properties of heights (Lemma \ref{lemma-height-functions}), $G(k)\Omega = G(\mathbb A)$. 
 
 We may fix again a good maximal compact subgroup $K$ with Iwasawa decomposition $G(\mathbb A) = B(\mathbb A)K$, and assume that $V$ is $K$-invariant. Writing an element of $[G]_B$ as $g=bk$, accordingly, and defining a Harish-Chandra function $H(g) = \log(b)\in \mathfrak a$, it is enough to show that $H(\Omega)$ lies in a translate of $\mathfrak a^+$. Such a translate is defined by equations $\left < \lambda, \alpha_i\right> \ge T_i$ for some scalars $T_i$ and any $i=1,\dots ,r$, i.e., we need to show that $\left< H(\Omega), \alpha_i\right>$ is bounded below, for all $i$. 
 
 By induction on $r$, we may assume this to be the case for $i \ge 2$. But then, to show it for $\alpha_1$, we may replace $G$ by the group $G'=$the Levi quotient of the parabolic $Q$ generated by $B$ and the root spaces proportional to $\alpha_1$. Indeed, the condition $\Vert v_1 \gamma g \Vert \ge \Vert v_1 g\Vert$ holds a fortiori for $\gamma \in Q (k)$, and $Q$ acts on $v_1$ through its Levi quotient. Thus, we are reduced to the case of $G$ being of \emph{semisimple rank one}, which we now assume. We may keep assuming that $G$ is semisimple, since the center evidently plays no role. But then we are in the case of $G = \text{SL}_2$, covered in Theorem \ref{theorem-reduction-SL2}, or $\text{PGL}_2$, which is similar. Thus, the theorem is proven. 
\end{proof}

We will now use Theorem \ref{theorem-reduction-theory-split} to construct a compactification of $[G]$. Set-theoretically, the compactification is
$$ {[G]}^{RBS} = \bigcup_P A_P\backslash [G]_P,$$
where $P$ ranges over all conjugacy classes of parabolics, so $A_P\backslash [G]_P$ is the $P$-cusp. Here, we are being a bit ambiguous about the meaning of $A_P$: it depends on which of the ``standard embeddings''  of $[G]_P$ (Definition \ref{definition-standard-embedding}) one chooses; corresponding to the choices in this definition, one can take $A_P = A_P(k_\infty)^0$, $A_P(k_\infty)$, or $[A_P]$. The last one this seems the most natural choice, in general, but, when $k = \mathbb Q$, and we take $A_P = A_P(k_\infty)^0$ (or, more generally, when $k$ is a number field, and we replace $k_\infty$ by the diagonal embedding of $\mathbb R$ in $k_\infty$), we obtain the \emph{reductive Borel--Serre compactification}, which is a manifold with corners (after we mod out by a sufficiently small compact open subgroup of $G(\mathbb A_f)$) --- this is why we use the notation ${[G]}^{RBS}$ in general. Thus, we will be using $A_P$, and leave it to the reader to choose their favorite version, except where we need to use a specific one.


We will define, more generally, an embedding $[G]^F$ for every fan $F$ of rational, strictly convex polyhedral cones supported in $\mathfrak a^-$, following \cite{Sakellaridis-stacks}. Set-theoretically, it will be the union of $G(\mathbb A)$-orbits $Z_C$, for all cones $C\in F$. The RBS compactification will be the one corresponding to $F=$ the fan consisting of the faces of $\mathfrak a^-_{ss}$. 

Assume, first, that $F$ is a fan supported entirely on the face of the anti-dominant cone corresponding to a parabolic $P$ with Levi quotient $L$, whose split center $A_P$ is canonically a subtorus of $A$. Then $F$ defines a toric embedding $A_P\hookrightarrow \overline{A_P}^F$, and we set:
\begin{equation}
\label{equation-LF} 
[L]^{F}:= \overline{A_P}^F\times^{A_P} [L],
\end{equation}
\begin{equation}
\label{equation-GF} 
[G]_P^{F}:= [L]^{F} \times^{P(\mathbb A)} G(\mathbb A).
\end{equation}
Its $G(\mathbb A)$-orbits are in natural bijection with cones in the fan, as is the case with $A_P$-orbits in $\overline{A_P}^F$. If $C\in F$ does not belong to the face corresponding to any larger parabolic,  we let $Z_C$ be the orbit corresponding to a cone $C$. If $C$ belongs to the face corresponding to a larger parabolic $Q$, we will denote its orbit by $Z_C^P$, because $Z_C$ will be defined by the analogous construction for $Q$.

For a general fan $F$, the $G(\mathbb A)$-space $[G]_P^{F}$ will be defined by the formula \eqref{equation-GF}, once $[L]^{F}$ is defined. To define $[L]^F$, we may assume that $L=G$, and that the spaces $[L]^{F}$, $[G]_P^{F}$ have been defined for all proper parabolics $P$.

We first consider the restriction $F_G$ of $F$ to $\mathfrak a_G$ (i.e.\ the sub-fan consisting of all cones which are contained in the central cocharacter space of $G$). By \eqref{equation-LF}, it defines an embedding $[G]^{F_G}$ of $[G]$. Now, all the strata $Z_C$ have been defined: If $C$ belongs to $\mathfrak a_G$, then $Z_C\subset [G]^{F_G}$. If not, then $Z_C$ has been defined is a stratum of $[G]_P^F$, for $P=$ the maximal parabolic such that $C\subset \mathfrak a_P$, and, by the inductive construction, it is a stratum of $[G]_Q^F$, for all $Q\supset P$ other than $G$. There remains to explain how to glue those onto $[G]^{F_G}$. 

It suffices to consider a maximal parabolic $P$. 
First, we lift the embedding $[G]_P^{F}$ to an embedding of the space $\overline{A_G}^{F_G} \times^{A_G} P(k)\backslash G(\mathbb A)$ (recall that $F_G$ is the restriction of $F$ to $\mathfrak a_G$), by considering the universal $G(\mathbb A)$-space $X$ fitting in a diagram of continuous, $G(\mathbb A)$-equivariant maps:
$$ \xymatrix{\overline{A_G}^{F_G} \times^{A_G} P(k)\backslash G(\mathbb A) \ar[d] \ar[r] & X \ar[d] \\ \overline{A_G}^{F_G} \times^{A_G} [G]_P \ar[r] & [G]_P^F},$$
where the first horizontal map is supposed to be an isomorphism over $\overline{A_G}^{F_G} \times^{A_G} [G]_P$.
Explicity, the universal such $X$ (to be denoted $\overline{P(k)\backslash G(\mathbb A)}^F$) is the union of $\overline{A_G}^{F_G} \times^{A_G} P(k)\backslash G(\mathbb A)$ with all $G(\mathbb A)$-orbits $Z_C\subset [G]_P^F$ with $C\in F$ not belonging to $\mathfrak a_G$. (We stress again that, for $C\subset \mathfrak a_G$, the corresponding orbit $Z_C^P\subset [G]_P^F$ is different from the orbit $Z_C \subset [G]^{F_G}$, which will be part of the final compactification $[G]^F$.)

Now, consider the pair of quotient maps \eqref{equation-leftright}. By Theorem \ref{theorem-reduction-theory-split}, there is an $[A_G]$-stable neighborhood of the $P$-cusp where the map $\pi_G$ is an isomorphism. Thus, we can glue $\overline{P(k)\backslash G(\mathbb A)}^F$ to $[G]$ over such a neighborhood. In fact, the map $\pi_G$ extends to a morphism 
$$ \overline{A_G}^{F_G} \times^{A_G} P(k)\backslash G(\mathbb A) \to [G]^{F_G},$$
which is an isomorphism on an $[A_G]$-invariant neighborhood of the $P$-cusp. All orbits $Z_C\subset \overline{P(k)\backslash G(\mathbb A)}^F$ with $C$ not belonging to $\mathfrak a_G$ have a neighborhood which is contained in such a neighborhood of the $P$-cusp, \emph{therefore we can use such a neighborhood to glue $Z_C$ to $[G]^{F_G}$}. 

Finally, if $Z_C\subset [G]_P^F$ and $Z_C\subset [G]_Q^F$ for two different maximal parabolics, there is a smaller parabolic $R\subset P\cap Q$ such that $Z_C\subset [G]_R^F$, and a neighborhood of $Z_C$ in $[G]_R^F$ is contained in a neighborhood of the $R$-cusp whose preimage in $R(k)\backslash G(\mathbb A)$ injects into both $P(k)\backslash G(\mathbb A)$ and $Q(k)\backslash G(\mathbb A)$, and into $[G]$. Thus, the way that $Z_C$ is glued to $[G]$ does not depend on the choice of maximal parabolic $P$ or $Q$.

\begin{definition}
 \label{definition-equivariant-toroidal-compactification}
The (partial) compactification $[G]^F$ described above, where $F$ is a fan supported on $\mathfrak a^-$, will be called the {\it equivariant toroidal compactification} attached to $F$. If $F=\mathfrak a^-_{ss}$, it will be denoted by $[G]^{RBS}$, for {\it reductive Borel--Serre compactification}. (It is a partial compactification if $\mathfrak a_G$ is nontrivial.)
\end{definition}

\begin{remark}
 \label{remark-toroidal-name}
The equivariant toroidal compactifications are not related to the ``toroidal compactifications'' of locally symmetric spaces, defined by Ash--Mumford--Rapoport--Tai in \cite{Ash-Mumford-Rapoport-Tai}. However, the name is appropriate as they are have the local structure of toric varieties. 
\end{remark}






\section{Reduction theory in the general case}
\label{section-reduction-theory-general}

We will now use the split case to deduce the general theorem of reduction theory. The main tool will be the compactification $[G]^{RBS}$ of Definition \ref{definition-equivariant-toroidal-compactification}, and the fact that ``it is defined over $k$'', in the following sense:

\begin{proposition}
 \label{proposition-RBS-Galois-stable}
 Let $G$ be a connected reductive group over $k$, and let $k\hookrightarrow l$ be a Galois extension, with Galois group $\Gamma$, such that $G$ splits over $l$. Then, the action of $\Gamma$ on $[G_l]$ extends continuously to the RBS compactification $[G_l]^{RBS}$.
\end{proposition}

\begin{proof}
 The basic ingredient of the proof is that \emph{the boundary degeneration $[G]_B$ is ``defined'' over $k$}, in the sense that $[G_l]_B$ admits a canonical action of $\Gamma$. The reason is that the flag variety $\mathcal B$ of $G$ is defined over $k$, even if $G$ has no Borel subgroups over $k$. Recall that $B(l)\backslash G(\mathbb A_l) = \mathcal B(l)\times^{G(l)}G(\mathbb A_l)$, so it has a natural action of $\Gamma$. This action descends to $[G_l]_B$ (= the quotient of $\mathcal B(l)\times^{G(l)}G(\mathbb A_l)$ by the group bundle of unipotent radicals over $\mathcal B(\mathbb A_l)$).
 
 The same holds for the partial flag varieties of the form $P\backslash G$, except that one has to group them into \emph{associate classes}: Two conjugacy classes of parabolics are called \emph{associate} if they have conjugate Levi subgroups. An associate class $\mathcal A$ of parabolics is a variety defined over $k$, such that $\mathcal A_l$ splits into a disjoint union of conjugacy classes $\mathcal P_i$ of parabolics. Thus, we have a well-defined action of $\Gamma$ on $\sqcup_i \mathcal P_i(l)$, and from this we obtain a well-defined action of $\Gamma$ on the union $\sqcup_i P_i(l)\backslash G(l)$, or the union of boundary degenerations $\sqcup_i [G_l]_{P_i}$. 
 
 Using these facts, it is not hard to see that the $\Gamma$-action extends to $[G_l]^{RBS}$; we leave the details to the reader.
\end{proof}


If, now, $G$ is a reductive group over $k$, and $k\hookrightarrow l$ is a Galois extension, with Galois group $\Gamma$, such that $G$ splits over $l$, we have an embedding $[G_k]\hookrightarrow [G_l]^\Gamma\hookrightarrow ([G_l]^{RBS})^\Gamma$.

\begin{proposition}
 \label{proposition-Gk-in-Gl}
If $\mathcal P$ is a conjugacy class of parabolics in $G_l$, and $[G_k]$ has an accumulation point in the $\mathcal P$-cusp of $[G_l]^{RBS}$, then $\mathcal P$ has an element $P$ defined over $k$. Moreover, there is a neighborhood $V$ of the $P$-cusp of $[G_l]^{RBS}$ such that $\pi_G(\tilde V) \cap [G_k] = \pi_G(\tilde V \cap P(k)\backslash G(\mathbb A))$, where $\pi_G$ is the map of \eqref{equation-leftright}. 
\end{proposition}

\begin{proof}
The statement is local over the $P$-cusp, so it is enough to replace ``neighborhood of the cusp'' by ``neighborhood of a compact subset of the cusp''. Let $V$ to be any $\Gamma$-stable neighborhood in $[G_l]_P$ of a compact subset of accumulation points of $[G_k]$ in the $P$-cusp, satisfying the conclusion of the injectivity statement (I) of Theorem \ref{theorem-reduction-theory-split}. If $[g]\in [G_k]$ is a point in $\pi_G(\tilde V)$ by the injectivity property, and the stability of $V$, $g$ under $\Gamma$, the preimage $\tilde g$ of $g$ in $\tilde V$ is also $\Gamma$-stable. But 
$$\tilde g \in P(l)g \in \mathcal P(l)\times^{G(k)}G(\mathbb A_k)\subset \mathcal P(l)\times^{G(l)}G(\mathbb A_l) = P(l)\backslash G(\mathbb A_l),$$
hence the Galois action on the subset $\mathcal P(l)\times^{G(k)}G(\mathbb A_k)$ mapping to $[G_k]$ comes entirely from its action on $\mathcal P(l)$ (more precisely, on $\mathcal A(l)$, where $\mathcal A$ is the union of associate classes to $\mathcal P$). Thus, the existence of a $\Gamma$-fixed point on $P(l)\backslash G(\mathbb A_l)$, mapping to $[G_k]$, implies that $\mathcal P(k) \ne \emptyset$, and $g\in [G_k]_P$.
\end{proof}




\begin{theorem}
 \label{theorem-reduction-theory-general}
Let $G$ be a reductive connected group over $k$, and $P\subset G$ a (class of) parabolic(s).
 \begin{description}
  \item[(C)] $[G]$ is compact iff $G$ is anisotropic (i.e., does not contain any split torus). 
  \item[(I)] Every compact subset of the $P$-cusp in $\overline{[G]_P}$ has a neighborhood $V$ such that $\pi_G|_{\tilde V}$ is injective, where $\tilde V$ is the preimage of $V$ in $P(k)\backslash G(\mathbb A)$.
  \item[(S)] Every $[A_G]$-invariant neighborhood of the degenerate $P$-cusp in $[G]_P$ (where $A_G$ is the maximal split torus in the center of $G$) can be scaled to a neighborhood $V$ such that $\pi_G|_{\tilde V}$ is surjective, where $\tilde V$ is as above. 
 \end{description}
\end{theorem}


\begin{proof}
Again, having addressed the case of tori in Proposition \ref{proposition-automorphic-tori}, we will now assume that $G$ is semisimple; the combination of the two to address the general case is left to the reader. 


We start with (C):  Let $k\hookrightarrow l$ be a Galois extension, with Galois group $\Gamma$, such that $G$ splits over $l$. Then, we have a closed embedding $[G_k]\hookrightarrow [G_l]^\Gamma$. If $[G_k]$ is not compact, then it has a $\Gamma$-stable accumulation point in some boundary component (some $P$-cusp) of $[G_l]^{RBS}$. By Proposition \ref{proposition-Gk-in-Gl}, it must have a proper parabolic, which contradicts the assumption that $G$ is anisotropic over $k$.

For (I), there is nothing to prove, since by embedding again $[G_k]\hookrightarrow [G_l]$, the statement follows from the corresponding statement for split groups, contained in Theorem \ref{theorem-reduction-theory-split}.

 
Now we pass to (S). The same argument as in the split case reduces us to the case of split semisimple rank one. Thus, we assume that $G$ has a unique class of proper parabolics $P$ over $k$.  Since $P$ is minimal, by the statement (C) applied to its Levi quotient $L$, its cusp will be compact, and therefore the neighborhoods of the $P$-cusp in $[G_k]$ coincide with the neighborhoods of the degenerate $P$-cusp. If, again, $l$ is a splitting field as above, and $V$ is any small neighborhood of the $P$-cusp in $[G_l]_P$ satisfying the conclusion of Proposition \ref{proposition-Gk-in-Gl}, the proposition shows that, on one hand, $[G_k]\smallsetminus \pi_G(\tilde V)$ is relatively compact, and on the other $P(k)\backslash G(\mathbb A)\cap \tilde V$ surjects onto $[G_k]\cap  \pi_G(\tilde V)$. Thus, there is an $A_P(\mathbb A)$-scaling $V'$ of $V\cap [G_k]_P$ such that $\pi_G(\tilde V') = [G_k]$. 
\end{proof}

Now we draw some corollaries from Theorem \ref{theorem-reduction-theory-general}: the finiteness of class numbers, and a more classical formulation, saying that $[G]$ can be covered by domains of a particular form, called \emph{Siegel sets}.

\begin{definition}
 \label{definition-fundamental-set-domain}
A {\it fundamental domain} for the action of a discrete subgroup $\Gamma$ on a locally compact group $G$ is an open subset $D$ of $G$ such that no two points of $D$ are in the same $\Gamma$-orbit, and such that $G= \cup{\gamma\in \Gamma} \gamma \bar D$. 

A {\it fundamental set} $\Omega$ for $\Gamma\backslash G$ is a subset of $G$ such that $\Gamma\cdot \Omega= G$ and the set $\{\gamma\in \Gamma | \gamma \Omega \cap \Omega \neq \emptyset\}$ is finite. 
\end{definition}


\begin{definition}
 \label{definition-Siegel-set}
Let $P\subset G$ be a minimal parabolic subgroup, and fix a maximal compact subgroup $K\subset G(\mathbb A)$ satisfying the Iwasawa decomposition $G(\mathbb A)= P(\mathbb A) K$. A {\it Siegel set} is a subset of $G(\mathbb A)$ of the form: $\Omega A_\epsilon K$, where: 
\begin{itemize}
 \item $\Omega$ is a compact subset of $P(\mathbb A)$;
 \item $A_\epsilon\subset A_P(k_\infty)$ (or, in the number field case, $A_\epsilon\subset A_P(\mathbb R)^0$, where $\mathbb R\hookrightarrow k_\infty$ is the diagonal embedding) is the subset of those elements $t$ satisfying $|e^\alpha(t)|>\epsilon>0$ for all positive roots $\alpha$. \footnote{More generally, one can specify different values of $\epsilon$ for different roots.}
\end{itemize} 
\end{definition}

Then, a corollary of Theorem \ref{theorem-reduction-theory-general} is:

\begin{theorem}
\label{theorem-Siegel-finiteness}
\begin{enumerate}
 \item For every compact open subgroup $J\subset G(\mathbb A_f)$, the number of $G(k_\infty)$-orbits on $[G]/J$ is finite.
 \item There exists a Siegel set which is a fundamental set for $[G]$.
\end{enumerate}
\end{theorem}

\begin{proof}
Let $P\subset G$ be a minimal parabolic, and $K\subset G(\mathbb A)$ a maximal compact subgroup satisfying the Iwasawa decomposition $G(\mathbb A) = P(\mathbb A)K$. Using the Iwasawa decomposition, the question is reduced to the question of $P(k_\infty)$-orbits on $[P]/J_P$, where $J_P$ is an open compact subgroup of $P(\mathbb A_f)$. If $P\to L\to L^{ab}$ are the Levi quotient of $P$ and its abelianization, a torus, the problem is easily reduced from $P$ to $L$ by means of Proposition \ref{proposition-automorphic-Ga}, from $L$ to $L^{ab}$ by means of the compactness of $[L']$, where $L'$ is the derived subgroup of $L$ (Statement (C) of Theorem \ref{theorem-reduction-theory-general}), and the case of $L^{ab}$ is Proposition \ref{proposition-automorphic-tori}.

For the second statement, first choose a compact subset $\Omega\subset P_0(\mathbb A)$, such that $U(k)\Omega \supset U(\mathbb A)\Omega$ (possible by Proposition \ref{proposition-automorphic-Ga}), and $U(\mathbb A) A_P(k_\infty) \Omega = G(\mathbb A)$ (or, respectively, $U(\mathbb A) A_P(\mathbb R) \Omega = G(\mathbb A)$ --- this is possible by the compactness of $[L']$, and the finiteness of the class number for tori, Proposition \ref{proposition-automorphic-tori}, applied to $L^{ab}$.

The surjectivity, now, of a subset of the form $\Omega A_\epsilon K$ onto $[G]$ follows from Statement (S) of Theorem \ref{theorem-reduction-theory-general}.
\end{proof}

\begin{remark}
 \label{remark-Ginfty-orbits}
By Theorem \ref{theorem-Siegel-finiteness}, the $G(k_\infty)$-space $[G]/J$ is a finite disjoint union
$$ \bigsqcup_i \Gamma_i \backslash G(k_\infty),$$
where $\Gamma_i = g_i^{-1}G(k)g_i \cap JG(k_\infty)$, for $g_i$ ranging over a set of representatives of the $G(k_\infty)$-orbits, is a discrete \emph{congruence subgroup}. 

\end{remark}


\section{Weak and strong approximation.}
\label{section-approximation}


\begin{definition}
 \label{definition-weak-approximation}
We say that a (geometrically integral) variety $X$ over $k$ satisfies {\it weak approximation} if:
\begin{quote}
 For every finite set of places $S$,  $X(k)$ is dense in $X_S=\prod_{v\in S} X(k_v)$.
\end{quote}
Equivalently, if:
\begin{quote}
 $X(k)$ is dense in $\prod_v X(k_v)$
\end{quote}
the product taken over all places. 

We say that $X$ has the property of weak approximation away from a finite set of places $\Sigma$ if this property holds with the product taken over all places outside of $\Sigma$. For instance, if $\Sigma=\infty$ and an integral model (i.e.\ the structure of an $\mathfrak o$-scheme, where $\mathfrak o$ is the ring of integers in $k$) is given, then weak approximation outside of $\Sigma$ means that for every finite set of finite places $S$, every integer $N$ and every set of points $(x_v \in X(k_v))_{v\in S}$ we can find $x\in X(k)$ such that $x\equiv x_v \mod \mathfrak p_v^N$.
\end{definition}

We have:
\begin{theorem}[Kneser, Platonov]
\label{theorem-weak-approximation}
 Let $G$ be semisimple simply connected or adjoint. Then $G$ satisfies weak approximation.
\end{theorem}

\begin{proof}
 See \cite[Theorem 7.8]{Platonov-Rapinchuk}.
\end{proof}

There are many more examples of groups which satisfy weak approximation, for instance $\text{GL}_n$. (Proof: $\text{GL}_{n,S}$ is open in $\text{Mat}_{n,S}$ and carries the induced topology, so since $\text{Mat}_n$ satisfies weak approximation, so does $\text{GL}_n$.) In fact, any split reductive group, being a rational variety (by the Bruhat decomposition), satisfies weak approximation. However, weak approximation can fail already for tori:

\begin{example}
 \label{example-failure-weak-approximation}
Let $L = \mathbb Q(\sqrt{-1},\sqrt{2})$, and let $T$ be the kernel of the norm map $L^\times \to \mathbb Q^\times$, considered as an algebraic torus over $\mathbb Q$. Then, the closure of $T(\mathbb Q)$ has index $2$ in $T(\mathbb Q_2)$; see \cite[p.423]{Platonov-Rapinchuk}.
\end{example}


\begin{definition}
 \label{definition-strong-approximation}
We say that a variety $X$ satisfies {\it strong approximation} away from a finite set of places $\Sigma$ if:
\begin{quote}
 $X(k)$ is dense in $X^\Sigma=X(\mathbb A^\Sigma)$. 
\end{quote}
Sometimes if $\Sigma=\infty$ we say that $X$ satisfies strong approximation without mentioning $\Sigma$. Hence, strong approximation (away from $\infty$) is a strengthening of the statement ``class number = 1''. Notice that the above condition is much stronger than being dense in $\prod_v(k_v)$, because the topology on the adeles is finer than the induced topology from $\prod_v(k_v)$. For instance, if $G=\text{GL}_n$ and $\Sigma=\infty$ then the property reads: For every set $S$ of finite places and for all $(x_v\in k_v)_{v\in S}$ \emph{there exist $S$-integers} in $k^\times$ (i.e.\ elements of $k^\times\cap \prod_{v\in S\cup\infty} k_v^\times \prod_{v\notin S\cup\infty} \mathfrak o_v^\times$) which approximate $(x_v)_{v\in S}$. 
 
\end{definition}



A slightly weaker version of the following theorem was proven by Kneser:
\begin{theorem}[Platonov, Prasad]
\label{theorem-strong-approximation}
 Let $G$ be an algebraic group over a global field $k$, and let $\Sigma$ be a finite set of places. Then, $G$ satisfies strong approximation outside of $\Sigma$ if and only if $G$ is connected and simply connected (in particular, semisimple), and there is no simple component $G_1\subset G$ over $k$ such that $G_1(k_\Sigma)$ is compact.
\end{theorem}

\begin{proof}
 See \cite[\S 7.4]{Platonov-Rapinchuk} for number fields, and for the ``only if'' statement. Prasad proved the function field case in \cite{Prasad-strong}. Let us only outline an elementary proof in the case of $\text{SL}_n$, for any nonempty set of places $\Sigma$: In this case, for any place $v$, the group $\text{SL}_n(k_v)$ is generated by the elementary subgroups $I+ k_v E_{ij}$ (where $E_{ij}$ is the matrix with $1$ in the $(i,j)$-th entry, and zero otherwise), and by the case of the additive group, Proposition \ref{proposition-automorphic-Ga}, $I+kE_{ij}$ is dense in $I+ \mathbb A^\Sigma E_{ij}$. Therefore, $\text{SL}_n(k)$ is dense in $\text{SL}_n(\mathbb A^\Sigma)$. 
\end{proof}


Notice that this statement implies, in particular, that $\text{SL}_n(\mathbb Z)$ is dense in $\text{SL}_n(\widehat{\mathbb Z})$, i.e.\ the map: $\text{SL}_n(\mathbb Z)\to \text{SL}_n(\mathbb Z/n)$ is surjective for every $n$. Such a result is certainly not true for the multiplicative group, for instance: $\mathbb Z^\times$ does not surject onto $(\mathbb Z/5)^\times$.

\begin{example}
 \label{example-failure-strong-approximation}
Here is an example for the failure of strong approximation: Assume that $G$ is a linear algebraic group, and $\Sigma$ is a finite, nonempty set of places such that $G(k_\Sigma)$ is compact. Since $G(k)$ is discrete in $G(\mathbb A) = G(\mathbb A^\Sigma) \times G(k_\Sigma)$, and $G(k_\Sigma)$ is compact, it follows that $G(k)$ is discrete in  $G(\mathbb A^\Sigma)$, and therefore it is not dense.
\end{example}


\section{The class number of a reductive group}
\label{section-class-number}

\begin{definition}
 \label{definition-class-number}
 Let $G$ be a linear algebraic group over the ring of integers $\mathfrak o$ of a number field $k$, or over the integers of a function field away from a non-empty set of places that we will denote as $k_\infty$. The cardinality of the set $G(k)\backslash G(\mathbb A_f)/\prod_{v\ne \infty} G(\mathfrak o_v)$ is the {\it class number} of $G$. 
\end{definition}

The class number is always finite, by Theorem \ref{theorem-Siegel-finiteness}. Here, we will use strong approximation (definitely a deeper fact than reduction theory) in order to get a more precise calculation of the class number in several cases.

\begin{proposition}
\label{proposition-class-number-abelianization}
Assume that the derived group $G'$ of $G$ is simply connected, and does not contain any factor $G_1'$ over $k$ with $G_1'(k_\infty)$ compact. Let $G^{ab}$ be the abelianization of $G$, $K\subset G(\mathbb A_f)$ a compact open subgroup, and $K^{ab}$ the image of $K$ in $G^{ab}$. 

Then, the double quotients $G(k)\backslash G(\mathbb A_f)/K$ and $G^{ab}(k)\backslash G^{ab}(\mathbb A_f)/K^{ab}$ are in bijection, under the natural map $G(\mathbb A_f)\to G^{ab}(\mathbb A_f)$.

In particular, the class numbers of $G$ and $G^{ab}$ coincide.
\end{proposition}

\begin{proof}
 By Theorem \ref{galoiscohomology-theorem-H1-trivial}, the Galois cohomology $H^1(k_v, G')$ is trivial for any finite place $v$, therefore the map $G(\mathbb A)\to G^{ab}(\mathbb A)$ is surjective. 
 
 Similarly, by Theorem \ref{galoiscohomology-theorem-Hasse-principle}, the Galois cohomology $H^1(k, G')$ injects into $H^1(k_\infty, G) := \prod_{v|\infty} H^1(k_v, G)$ (actually, surjects, by Proposition \ref{galoiscohomology-proposition-H1-surjects}, but we won't use that).
 
 Hence, we have exact sequences $G(k)\to G^{ab}(k) \to H^1(k_\infty, G')$ and $G(\mathbb A)\to G^{ab}(\mathbb A) \to H^1(k_\infty,G')$, compatible with the embeddings $G(k)\to G(\mathbb A)$ and $G^{ab}(k)\to G^{ab}(\mathbb A)$, and, in particular, since $G^{ab}(\mathbb A_f)$ lies in the kernel of the map to $H^1(k_\infty, G')$, the images of $G(k)$ and $G^{ab}(k)$ in $G^{ab}(\mathbb A_f)$ are equal. 
 
 Thus, the fiber [...]
 
 Therefore, the quotients $G(k)\backslash G(\mathbb A_f)/K$ and $G^{ab}(k)\backslash G^{ab}(\mathbb A_f)/K^{ab}$ are in bijection.
\end{proof}

Notice that this gives a group structure to the double quotient $G(k)\backslash G(\mathbb A_f)/K$ and, in particular, we can talk about the class group of $G$. More generally, 

\begin{proposition}
 \label{proposition-class-group}
 \cite[Proposition 8.8]{Platonov-Rapinchuk}
\end{proposition}

\begin{proof}
 
\end{proof}


\begin{definition}
 \label{definition-class-group}
If $G$ satisfies the conditions of Proposition \ref{proposition-class-group}, the double quotient $G(k)\backslash G(\mathbb A_f)/\prod_{v\ne \infty} G(\mathfrak o_v)$, with the group structure inherited from this proposition, is the {\it class group} of $G$. 
\end{definition}

For more general reductive groups, we can analyze their class number/group with the help of \emph{$z$-extensions}:

\begin{definition}
 \label{definition-z-extention}
A {\it $z$-extension} of a reductive group $G$ is a short exact sequence of algebraic (necessarily reductive) groups
$$ 1\to T\to \tilde G\to G\to 1,$$
where $T$ is an induced torus (Definition \ref{algebraicgroups-definition-induced-torus}), and the derived group of $G'$ is simply connected.
\end{definition}

\begin{proposition}
 \label{proposition-z-extension-exists}
Any reductive group over a field $k$ admits a $z$-extension.
\end{proposition}


\begin{proof}
\end{proof}

[To be continued: describe the class group of $G$ in terms of the class group of $\tilde G^{ab}$, where $\tilde G$ is a $z$-extension.]

\section{Tamagawa numbers}
\label{section-Tamagawa-numbers}
	
	
\subsection{Motivating example I}
\label{subsection-example1}
	Consider the group $\mathrm{SL}_2/\mathbb{Q}$, on which we have an invariant algebraic differential $\omega = dx dy dz/x$, where we are realizing $\mathrm{SL}_2$ as matrices of the form 
	$\begin{pmatrix}
	x&y\\z&\frac{1+yz}{x}
	\end{pmatrix}$. As such we obtain an invariant measure $\mu_\infty = |\omega|$ 
	on the Lie group 
	$\mathrm{SL}_2(\mathbb{R})$. Since the quotient 
	$\mathrm{SL}_2(\mathbb{Z})\backslash \mathrm{SL}_2(\mathbb{R})$ is of finite volume, we may try to consider the measure induced by $\mu_\infty$ on it, and compute its mass. And, it turns out we get the number $\zeta(2)=\pi^2/6$.
	
	
	On the other hand we may consider the $p$-adic analogues: consider the group $\mathrm{SL}_2(\mathbb{Q}_p)$, and we form $\mu_p = |\omega|_p=|dxdydz/x|_p$ (in the following we drop the subscript $p$ for simplicity), which we understand as a real-valued measure by setting $dx(\mathbb Z_p)=1$. Now, we compute the mass of $\mathrm{SL}_2(\mathbb{Z}_p)$ under $\mu_p$. Consider the subgroup $1+p\mathrm{Mat}_2(\mathbb{Q}_p)$: it has mass $1/p^3$ by our measure since it coincides with $(1+p\mathbb{Z}_p)\times (p\mathbb{Z}_p)^2$ in coordinates $(x,y,z)$. Also, this subgroup is open compact, with number of coset representatives equal to $|\mathrm{SL}_2(\mathbb{F}_p)|=p(p^2-1)$. So we conclude that $\mu_p(\mathrm{SL}_2(\mathbb{Z}_p)) = 1-p^{-2}$, seemingly miraculous to coincide with the reverse of the Euler factor of $\zeta(2)$ at $p$! Hence, we see that 
	$\mu_\infty(\mathrm{SL}_2(\mathbb Z)\backslash \mathrm{SL}_2(\mathbb R))\cdot \prod_p \mu_p(\mathrm{SL}_2(\mathbb{Z}_p)) = 1$.
	
	A nice way to (partly) reformulate our computation is that, when we use the measure $\prod_v \mu_v$ on $\mathrm{SL}_2(\mathbb{A})$, the mass of the compact quotient $\mathrm{SL}_2(\mathbb{Q})\backslash \mathrm{SL}_2(\mathbb{A}) \simeq \mathrm{SL}_2(\mathbb{Z})\backslash \mathrm{SL}_2(\mathbb{R}) \times \prod_p \mathrm{SL}_2(\mathbb{Z}_p)$ is 1. This example is in fact almost general enough to the classical definition of the Tamagawa measure and the attached Tamagawa number, being the generalization of $\prod_v \mu_v$ and the mass of $G(\mathbb{Q})\backslash G(\mathbb A)$ when $G$ is semisimple. 
	
	
\subsection{Motivating example II}
\label{subsection-example2}
	Now consider the group $\mathrm{SO}_2/\mathbb{Q}$, or more precisely the special orthogonal group for the rational quadratic form $Q(x,y)=x^2+y^2$. We realize $\mathrm{SO}_2$ as matrices of the form 
	$\left[\begin{matrix}
	a& -b \\ b&a
	\end{matrix}\right]$ where $a^2+b^2=1$, and one can check that the algebraic differential $\omega = da/b$ is invariant. 
	
	Now we can imitate the previous example: for real points, $\mathrm{SO}_2(\mathbb{R})$ is already compact, and the mass is 
	\[\int_{(a,b)\in S^1}\left|\frac{da}{b}\right|_\infty = 2\int_{-1}^1 \frac{dx}{\sqrt{1-x^2}} = 2\pi.\]
	
	Next for a prime $p\ne 2$, we consider the group $\mathrm{SO}_2(\mathbb{Q}_p)$ and $\mu_p = |\omega|_p=|da/b|_p$, with the group being identified as $\{(a,b)\in \mathbb{Q}_p^2:a^2+b^2=1\}$. We use again the trick of reduction (which is available as the quadratic form is integral): the map $\mathrm{SO}_2(\mathbb{Z}_p)\to \mathrm{SO}_2(\mathbb{F}_p)$ is surjective, as when $p\ne 2$ the derivatives of $Q$ doesn't vanish and we may employ a Hensel-lemma type of argument. Furthermore, the kernel of the reduction map is same as $\mathrm{SO}_2(\mathbb{Z}_p)\cap 1+p\mathrm{Mat}(\mathbb{Z}_p)$, which is parametrized by $b\in p\mathbb{Z}_p$, and hence on it $|da/b|_p = |-db/a|_p = |db|_p$, and hence the mass of the kernel is equal to $1/p$. Next we count $|\mathrm{SO}_2(\mathbb{F}_p)|$. When $\sqrt{-1} \in \mathbb{F}_p$ we see the group is the same as 
	$\{(a,b)\in \mathbb{F}_p: (a+ib)(a-ib)=1\}$,
	which is in bijection with $\mathbb{F}_p^\times$ by the map $(a,b) \mapsto a+ib$. So the number is $p-1$. When $\sqrt{-1}\notin \mathbb{F}_p$ denote $q= p^2$. We then have an embedding 
	\[\mathrm{SO}_2(\mathbb{F}_p) \to \mathbb{F}_q^\times \qquad (a,b)\longmapsto a+ib,\]
	the image being identified with $u\in \mathbb{F}_q^\times$ having norm 1. Now again using $p\ne 2$ we can show the norm map $\mathbb{F}_q^\times \to \mathbb{F}_p^\times$ is surjective, and hence $|\mathrm{SO}_2(\mathbb{F}_p)| = \frac{p^2-1}{p-1}=p+1$. So in summary, when $p\ne 2$ the mass of $\mathrm{SO}_2(\mathbb{Z}_p)$ is $1-\chi(p)/p$, where $\chi(p)$ is the Legendre symbol $(\frac{-1}{p})$.
	
	
	At $p=2$, one can carry out a small computation to verify that the mass is $1 = 1/2\cdot 2$ again using reduction (albeit not surjective). Thus we did all the local computations. 
	
	Finally to put everything together, we see that, while $\prod_{p\ne 2}(1-\chi(p)/p)$ is not absolutely convergent, we may ``equate'' it to the reverse of $1-1/3+1/5-1/7+\cdots = \pi/4$ by the formula of Leibniz. And by multiplying with the mass at $\infty$ we get $8$. To convert this to our reformulation as before, it asserts that, if we define the \textit{Tamagawa measure} $\mu = \frac{1}{L(1,\chi)}\mu_\infty\cdot \prod_p L_p(1,\chi)\mu_p$ to ensure the convergence, then it becomes a measure on $\mathrm{SO}_2(\mathbb{A})$, and the mass of $\mathrm{SO}_2(\mathbb{Q})\backslash \mathrm{SO}_2(\mathbb{A})\simeq \mathrm{SO}_2(\mathbb{R})/\mu_4 \times \prod_p \mathrm{SO}_2(\mathbb{Z}_p)$ is 2.
	
\subsection{Volume forms and measures}
\label{subsection-measures}
	
	To a top algebraic differential on a linear algebraic group we want to attach a measure on its points over a local field.  
	
\begin{definition}
 \label{definition-standard-Haar}
The {\it standard Haar measure} $dx$ on $\mathbb A$ is the measure that assigns volume $1$ to the quotient $\mathbb A/k$. The {\it standard multiplicative Haar measure} on $\mathbb A^\times$ is the measure $\frac{dx}{|x|}$. 
\end{definition}

\begin{remark}
 \label{remark-local-measures}
The standard Haar measure on $\mathbb A$ can be factorized as $\prod_v dx_v$, where $dx_v$ is a Haar measure on $k_v$. Although there is no ``canonical'' Haar measure on $k_v$, there is a standard choice that one can make, which at every non-Archimedean completion with discriminant $D_v$ over the base field ($\mathbb Q_p$ or $\mathbb F_p(t)$) assigns mass $|D_v|^{-\frac{1}{2}}$ to the ring of integers $\mathfrak o_v$, at real places is the usual Lebesgue measure, and at complex places is twice the usual Lebesgue measure.
\end{remark}



\begin{definition}
 \label{definition-absolute-value-measure}
Let $F$ be a local field, endowed with a Haar measure $dx$, and let $X$ be a smooth algebraic variety of dimension $n$ over $F$. Let $\omega$ be a volume form on $X$. The {\it absolute value of the volume form} $\omega$ is the measure $|\omega|$ which, in any open chart $(U ,(x_i)_i)$, that is, an open subset (in the $F$-topology) $U\subset X(F)$ endowed with a set of algebraic coordinates $x_1, \dots, x_n$, if $\omega$ is written as $f(\underline x) dx_1 \wedge \cdots \wedge dx_n$, then $\left. |\omega| \right|_{U}$ is equal to the measure $|f(\underline x)| dx_1 \cdots dx_n$.
\end{definition}

By ``a set of algebraic coordinates'' we mean a set of algebraic functions $x_1, \dots x_n$, which are regular at all points of $U$, and such that the volume form $\omega'=dx_1 \wedge \dots \wedge dx_n$ is nowhere vanishing on $U$; hence, the quotient $\frac{\omega}{\omega'}$ is a rational function that is regular at all points of $U$. The definition, of course, presupposes that the measure $|f(\underline x)| dx_1 \cdots dx_n$ does not depend on the coordinates chosen, which is easily checked. See also Weil's \cite{Weil-adeles}.

When $X$ is a smooth scheme over the ring of integers $\mathfrak o$ of a non-Archimedean field, with ``standard'' choices of measures, this measure is just counting points over the residue field:

\begin{lemma}
 \label{lemma-integral-pointcounting}
Suppose that $X$ is a smooth scheme of dimension $n$ over the ring of integers $\mathfrak o$ of a non-Archimedean field $F$, with residue field $\mathbb F_q$. If $\omega$ is a volume form on $X$ that is defined over $\mathfrak o$ and residually non-vanishing, then 
$$ \int_{X(\mathfrak o)} |\omega| = q^{-n} \# X(\mathbb F_q),$$
when $|\omega|$ is defined with respect to the measure on $F$ that assigns mass $1$ to $\mathfrak o$.
\end{lemma}


\begin{proof}
 By smoothness (Hensel's lemma), the map $X(\mathfrak o)\to X(\mathbb F)$ is surjective, so we need to show that the preimage of every point in $X(\mathbb F_q)$ has mass equal to $q^{-n}$. 

 By smoothness, locally on $X$, there is an embedding $X \hookrightarrow A_{\mathfrak o}^r$, where $A_{\mathfrak o}^r$ denotes affine $r$-space over $\mathfrak o$ (whose coordinates we will denote by $x_i$), and a set of $r-n$ equations $f_{n+1}, \dots,  f_{r}$, such that $df_{n+1}\wedge \cdots \wedge f_r$ is nowhere vanishing, such that $X$ is the zero locus of the $f_i$'s. By Hensel's lemma, the map $X(\mathfrak o)\to X(\mathbb F)$ is surjective, and for any point $x = (x_i)_i \in X(\mathfrak o)$, the points with coordinates $(x_1+\mathfrak p, x_2+\mathfrak p, \dots, x_n+\mathfrak p)$ lift uniquely to $X(\mathfrak o)$. This defines a bijection from $\mathfrak p^n$ to the residual neighborhood of $x$; moreover, $\omega$ can be written as a nowhere vanishing, integral multiple of $dx_1 \wedge \cdots \wedge dx_n$, hence $|\omega| = dx_1 \cdots dx_n$. Therefore, the volume of this neighborhood is $\int_{\mathfrak p^n} dx_1 \cdots dx_n = q^{-n}$.
\end{proof}


Now, we discuss volume forms on algebraic groups.

\begin{lemma}
 \label{lemma-Haar-volume-form}
If $G$ is an algebraic group over a field $k$, then $G$ has a unique, up to scaling, nonzero right-invariant volume form $\omega_G^R$, and a unique, up to scalar, nonzero left-invariant volume form $\omega_G^L$. There is a character $\partial_G: G\to \mathbb G_m$ such that, if $\omega_G^R$ is a right-invariant volume form on $G$, then $\omega_G^R(ag) = \partial_G(a) \cdot \omega_G^R(g)$, or equivalently, $\partial_G$ is the quotient $\frac{\omega_G^R}{\omega^L_G}$ between a right- and a(n appropriately scaled) left-invariant volume form. 

If $G$ is reductive, unipotent, or projective (i.e., an abelian variety), then $\partial_G = 1$, i.e., left- and right-invariant volume forms coincide.
\end{lemma}

	
\begin{proof}
		Take a nonzero vector from $\wedge^{\dim(G)} \mathfrak{g}^*$ at the identity, and translate it by right- or left-multiplication. As such we obtain a left- (resp.\ right-)invariant nonvanishing global section $\omega_G^L$ (resp.\ $\omega_G^R$) trivializing the sheaf of volume forms:  $\wedge^{\dim(G)}\Omega_{G/k} =   \mathcal{O}_G\cdot \omega_G^L = \mathcal{O}_G\cdot \omega_G^R$. Immediate from this:
		\begin{itemize}
			\item The quotient $\omega_G^L/\omega_G^R$ is an invertible global function. 
			\item The set of left-(right-) invariant differentials is a one dimensional $k$-subspace.
		\end{itemize}

		The action of $G$ by left translations on the one-dimensional space of right-invariant sections of $\wedge^{\dim(G)}\Omega_{G/k}$ defines the algebraic character $\partial_G: G\to \mathbb G_m$. It is easily checked that $\partial_G$ is the character of the left coadjoint representation of $G$ on the one-dimensional space $\bigwedge^{\text{top}} \mathfrak g^*$.
		
		Unipotent algebraic groups do not have nontrivial algebraic characters, by the Jordan decomposition. For an abelian variety there is no nontrivial character since it only has constant global functions. In the reductive case, because roots come in opposite pairs, the determinant of the coadjoint representation is trivial on semisimple elements, hence (by density of semisimple elements) on the entire group.
\end{proof}

\begin{definition}
\label{definition-modular-character}
		A left- or right- invariant volume form on an algebraic group $G$ is called a (left- or right-) {\it Haar volume form}. The character $\partial_G$ of Lemma \ref{lemma-Haar-volume-form} (or, abusing the notation when $G$ is over $F$, its absolute value on $G(F)$, $\delta_G(g) = |\partial_G(g)|$) is called the {\it modular character} of $G$.\footnote{The convention in Bourbaki is the opposite one: left over right; however, right over left is the standard definition of the modular character in more recent literature.} The group $G(F)$ is {\it unimodular} if $\delta_G=1$.
\end{definition}
	
	
	
\subsection{Definition of Tamagawa measure}
\label{subsection-definition-tamagawa}

An interesting feature of adelic groups is that they come with \emph{canonical} measures. The idea of the definition is as follows: Given an algebraic group $G$ over a global field $k$, a (left- or right-)invariant volume form $\omega$ gives rise to a measure $\mu_v = |\omega|_v$ at every place, and we will set $\mu=\prod_v \mu_v$ on $G(\mathbb{A})$, the Tamagawa measure. If the definition makes sense, it will be independent of the choice of $\omega$, because any other invariant volume form is of the form $a\omega$ with $a\in k^\times$, and $|a\omega|=|a|\cdot |\omega|=|\omega|$, by the product formula. Still, this definition needs some caution, because of the Euler product; we need to make sure that $\prod_v \mu_v$ is finite on compact subsets of $G(\mathbb{A})$. This amounts to making sense of the partial Euler product $\prod_{v\notin S} G(\mathfrak o_v)$, where $S$ is a finite number of places, including the Archimedean ones and we are fixing a model for $G$  over the $S$-integers $\mathfrak o_S$. Taking $S$ large enough, we may assume that $G$ is a reductive group scheme over $\mathfrak o_S$.

If $G$ is a reductive group scheme over $\mathfrak o_v$, the volume of $G(\mathfrak o_v)$ is expressed in terms of the \emph{motive of $G$},\footnote{For everything that follows, the reader can interpret ``motive'' as ``$\ell$-adic Galois representation'', for the decomposition group at a non-Archimedean place of residual degree $q=p^r$, $p\ne \ell$. The Tate motive $\mathbb Z(1)$ corresponds to the module $\lim_{\underset{n}\leftarrow} \mu_{\ell^n}$ on which the Frobenius morphism acts as multiplication by $q$}  see \cite{Gross-motive}:
	
\begin{definition}
\label{definition-motive-G}
		Let $G$ be a connected reductive group defined over a field $k$, with absolute Galois group $\Gamma$. Let $T$ be the universal Cartan of $G$ (Definition \ref{algebraicgroups-definition-universal-Cartan}), with absolute Weyl group $W$ and absolute cocharacter group $X_{*,k^s}(T)$. Set $\mathfrak c = \mathfrak t\sslash W$, where $\mathfrak t = X_{*,k^s}(T) \otimes \mathbb Q$, where $T$ is a maximal torus, and notice that it contains a distinguished point $0\in \mathfrak c$, the image of $0\in \mathfrak t$. 
		
		We define $M_G^\vee(1) = $ the tangent space $V=T_0\mathfrak c$ as a vector space, considered as a graded $\mathbb Q$-vector space with the grading descending from the $\mathbb G_{m, \mathbb Q}$-action on $\mathfrak t^*$, and as a $\Gamma$-module by $M_G^\vee(1)  = \bigoplus_d V_d(d)$, i.e., the twist of the natural $\Gamma$-action on $V$ by the $d$-th power of the Tate motive on the $d$-th graded piece. We define the {\it motive of $G$} to be the motive $M_G$, defined as the notation suggests, i.e., $M_G = (M_G^\vee(1))^\vee(1) = \bigoplus_d V_d^\vee(1-d)$.
\end{definition}
	
	
\begin{proposition}
\label{proposition-measure-integers}
		Let $G$ be a reductive group scheme over the valuation ring $\mathfrak o$ of a local non-Archimedean field $F$ with residue field $\mathbb F_q$, and let $\omega$ be an invariant volume form on $G$, defined over $\mathfrak o$ and residually non-vanishing. Then,
		\begin{equation}
		\label{equation-measure-integers}
		\int_{G(\mathfrak o)} |\omega| = |G(\mathbb F_q)|/q^{\dim(G)} = L(M_G^\vee(1))^{-1} = \det(I-\mathcal F|M^\vee(1)), 
		\end{equation}
		where $\mathcal F$ is the geometric Frobenius morphism (acting by $q^{-1} \text{ on } \mathbb Q(1)$).
\end{proposition}
	
Note that, under the assumption that $G$ is reductive over $\mathfrak o$, the action of $\Gamma$ on $M^\vee(1)$ is unramified.	

\begin{proof}
	The equality of the integral with $|G(\mathbb F_q)|/q^{\dim(G)}$ is Lemma \ref{lemma-integral-pointcounting},  and the number of points over the finite field is a result of Steinberg \cite[p79]{Steinberg-endomorphism}. [This is an important result with number-theoretic consequences; its proof should be added.]
\end{proof}
	
	
\begin{proposition}
\label{proposition-Tamagawa-canonical}
		Let $G$ be a connected, reductive group over the global field $k$, and let $\omega$ be a nonzero right-invariant volume form on $G$ over $k$. Fix a finite set $S$ of places, including the Archimedean ones, a reductive model for $G$ over the $S$-integers $\mathfrak o_S$, such that the form $\omega$ is integral and residually nonvanishing, and a factorization $dx = \prod_v dx_v$ of the standard Haar measures on $\mathbb A$ (Definition \ref{definition-standard-Haar}) such that $dx_v(\mathfrak o_v) = 1$ for $v\notin S$. Then:
		\begin{enumerate}
			\item The partial $L$-function 
			$$ L^S(M^\vee(1), s)= \prod_{v\notin S} \det(I- q_v^{-s} \mathcal F_v|M^\vee(1))^{-1}$$
			admits a meromorphic continuation to $s=0$, with pole of order equal to the $k$-character group of $G$.
			\item The Haar measure $\mu_{Tam}$ on $G(\mathbb A)$, which assigns to an open neighborhood $U= \prod_v U_v$ of the identity, with $U_v = G(\mathfrak o_v)$ for $v\notin S$ the value 
			$$ \mu_{Tam}(U) = \frac{\prod_{v\in S} |\omega|_v(U_v)}{L^S(M^\vee(1))^* },$$
			where $L^S(M^\vee(1))^*$ is the leading coefficient of the Laurent expansion of $L^S(M^\vee(1),s)$ at $s=0$, is independent of the volume form $\omega$, the set of places $S$, or the integral model of $G$ over $\mathfrak o_S$.
		\end{enumerate}
		
\end{proposition}
	
	
\begin{proof}
	By the definition of $M^\vee(1)$, the $L$-function 	$L(M^\vee(1), s)$ is a product of Artin $L$-functions evaluated at the points $s+d$, where $d$ varies over the fundamental invariants of the group; thus, $s=0$ corresponds to a point in the domain of convergence of the Euler product, except for the factor with $d=1$, which corresponds to the linear invariants $\mathfrak z \hookrightarrow \mathfrak c$, where $\mathfrak z\subset\mathfrak t$ is spanned by the cocharacters into the center of $G$. The order of pole is equal to the multiplicity of the trivial representation in $\mathfrak z$, which is equal to the order of the $k$-character group of $G$.
		
	The second statement follows from Proposition \ref{proposition-measure-integers} and the product formula: adding more places to the set $S$ will multiply the numerator and the denominator by the same factor; this depends only on the reductivity of the integral model away from $S$; and, any other invariant volume form is equal to $c\cdot \omega$ for some $c\in k^\times$; for it to be also integral and residually nonvanishing over $\mathfrak o_S$, we must have $c\in \mathfrak o_S^\times$, and then the product formula shows that $\prod_{v\in S} |c\omega|_v = \prod_{v\in S} |\omega|_v$. 
\end{proof}
	
	
	
	
	
\begin{definition}
\label{definition-Tamagawa-measure-number}
The {\it Tamagawa measure} on $G(\mathbb A)$ (or on $[G]$) is the measure $\mu_{Tam}$ of Proposition \ref{proposition-Tamagawa-canonical} (resp., its descent to $[G]$).  
		
The {\it Tamagawa number} of $G$ is the number
\begin{equation}
\label{equation-Tamagawa-number}
\tau(G) = \text{AvgVol}([G],\mu_{Tam}) = \lim_{c\to\infty} \frac{\mu_{Tam}(\log^{-1}(cB))}{\text{Vol}(cB)},
\end{equation}
where $\log: [G] \to \mathfrak a_G = \Hom(G, \mathbb G_m)^\vee \otimes \mathbb R$ is the logarithmic map defined as in \eqref{equation-logmap}, $B$ is the unit ball of any norm on the real vector space $\mathfrak a_G$, and $\text{Vol}(cB)$ is taken with respect to the measure on $\mathfrak a_G$ which assigns covolume $1$ to the lattice $\Hom(G, \mathbb G_m)^\vee$. 
\end{definition}
	
	
\begin{remark}
\label{remark-Tamagawa-measure}
		This definition is usually expressed in terms of the volume of $[G]^1=\{g\in [G]| \forall \chi\in \Hom(G, \mathbb G_m), |\chi(g)|=1\}$, which one endows with the Haar measure $\mu_{Tam}'$ such that the measure $\mu_{Tam}$ on $[G]$ factorizes as
		$$ \int_{[G]} \mu_{Tam} = \int_{\mathfrak a_G} (\int_{[G]^1} \mu_{Tam}') dx,$$
		with $dx$ the same measure on $\mathfrak a_G$ as in the definition, see \cite{Oesterle-Tamagawa}. In the case of the function field of a curve over a finite field with $q$ elements, the image of $[G]$ in $\mathfrak a_G$ is not the entire space, but just the lattice $\log q \cdot \Hom(G, \mathbb G_m)^\vee$, and the above integral over $\mathfrak a_G$ should be replaced with a sum over that lattice, multiplied by $\log q$. The definition with ``average volume'' unifies the number field and function field cases, and provides a more conceptual way to understand the regularization procedure, whereby the infinite $L^S(M^\vee(1),0)$ is replaced by its leading coefficient $L^S(M^\vee(1))^*$: formally, we are computing the volume of \emph{the entire space} $[G]$ with respect to a measure defined using the infinite quantity $L^S(M^\vee(1),0)$. The ``infinities'' of the space $[G]$ and this quantity are ``of the same order'', and cancel each other.
\end{remark}
 
	
	
\subsection{The Tamagawa number conjecture}
\label{subsection-Tamagawa-conjecture}
	\begin{theorem}[Conjecture of Weil, theorem of Langlands-Lai-Kottwitz]
		\label{theorem-weil}
		For any simply connected semisimple linear algebraic group $G$ over a global field, $\tau(G)=1$.
	\end{theorem}

\begin{proof}
	The proof of Weil conjecture over number fields, to name the most prominent contributions, was started by Langlands using Eisenstein series, generalized by King Fai Lai, and completed by Kottwitz in \cite{Kottwitz-Tamagawa}. Strictly speaking, the proof was not fully finished by Kottwitz's Annals paper, as it relies on the the Hasse principle due to works of Kneser and Harder, who proved it only for groups without $E_8$ factors. Its complete resolution only came after Chernousov proved the Hasse principle for $E_8$ in his 1989 paper. Over function fields, a completely different proof was given by Gaitsgory and Lurie \cite{Gaitsgory-Lurie}. 
\end{proof}
	
	
	As a \emph{corollary}, we state the following.
	
\begin{theorem}[Ono-Sansuc]
		\label{theorem-general-weil}
		For any semisimple linear algebraic group $G$ over a global field $E$, let $\tilde{G}\to G$ be its simply connected cover over the same field and $M$ the kernel. Then
		\[\tau(G) = \frac{|X^*(M)^{\Gamma_E}|}{|Sha(X^*(M))|} = \frac{|\mathrm{Pic}(G)|}{|Sha(G)|},\]
		where for a $\Gamma_E$-module $A$ (where $\Gamma_E = \text{Gal}(\bar E/E)$ for a separable closure $\bar E$), $Sha(A)$ denotes the obstruction group $\ker(H^1(E,A)\to 
		\prod_{v:\text{ places of }E} H^1(E_v,A))$, and $Sha(G) = Sha(G(\bar E))$.
\end{theorem}

\begin{proof}
		That the first equality is a corollary of the Tamagawa number conjecture is proved by Ono in \cite{Ono-relative-Tamagawa}. The second equality is due to Sansuc in \cite{Sansuc-Brauer}. In Kottwitz's final paper \cite{Kottwitz-Tamagawa} the formula takes a slightly different form, and its relation to the formula of Sansuc is explained in \cite{Kottwitz-cuspidal-tempered}. Of course, we should also be able to specialize to \ref{theorem-weil}. And this follows from Sansuc's formula and
		\begin{itemize}
			\item $\mathrm{Pic}(G)=1$ if $G$ is simply connected \cite[Cor.~18.24]{Milne-algebraic-groups}.
			\item The Hasse principle mentioned above, due to Kneser, Harder, Chernousov.
		\end{itemize}
\end{proof}
	

\subsection{Application: The Smith--Minkowski--Siegel mass formula for quadratic forms}
\label{subsection-mass-formula}

\begin{definition}
\label{definition-quadratic-module}
    Let $R$ be a commutative ring. A {\it quadratic module} over $R$ is an $R$-module $\Lambda$ equipped with a {\it quadratic form}, i.e., a map $q: \Lambda\rightarrow R$  such that 
    \begin{enumerate}
    \item The map $ \Lambda\times \Lambda \rightarrow  R$ given by $(\lambda,\lambda')\mapsto q(\lambda+\lambda')-q(\lambda)-q(\lambda')$ is $R$-bilinear. 
    \item $q(r\lambda)=r^2q(\lambda)$ for any $\lambda\in \Lambda$ and $r\in R$.
    \end{enumerate}
    We will consider quadratic modules as a groupoid, that is, a morphism of quadratic modules $(\Lambda_1, q_1)$, $(\Lambda_2,q_2)$ is an isomorphism of $R$-modules $T:\Lambda_1\xrightarrow\sim \Lambda_2$ with $T^*q_2 = q_1$. The automorphism group of of $(\Lambda, q)$ is its {\it orthogonal group}, denoted by $\text{O}_q(R)$. 
\end{definition}

\begin{remark}
\label{remark-orthogonal-group}
 The base change $\Lambda \otimes_R R'$ of a quadratic module $(\Lambda, q)$ to an $R$-algebra $R'$ is a quadratic module. When $R$ is finitely generated, the functor $R'\to \text{O}_q(R')$ is represented by a closed subgroup scheme of $\text{GL}_\Lambda$ over $R$.

  We will be writing $q_1 \overset{R'}\sim q_2$ to denote that two quadratic forms are isomorphic over an $R$-algebra $R'$.
\end{remark}

From now on we work, without extra mentioning, with quadratic forms on $\mathbb Z$-lattices, i.e., finitely generated free $\mathbb Z$-modules. The lattice will sometimes be implicit in the notation.

\begin{definition}
\label{definition-genus}
	The \textit{genus} of a quadratic form  $q$ over $\mathbb Z$ is the class of all quadratic forms $q'$ that $q\overset{\mathbb{Z}_p}{\sim} q'$ for all primes $p$ and $q\overset{\mathbb{R}}{\sim} q'$. 
\end{definition}

We will consider the genus as a groupoid, as well, with respect to $\mathbb Z$-equivalence.

\begin{theorem}[Hasse principle]
\label{theorem-Hasse-principle}
	Let $q$ and $q'$ be two quadratic forms over $\mathbb{Q}$, then $q$ is equivalent to $q'$ over $\mathbb{Q}$ if and only if $q$ and $q'$ are equivalent over $\mathbb{Q}_p$ for all primes $p$ and equivalent over $\mathbb{R}$.  
\end{theorem}
\begin{proof}
	See \cite[p.44]{Serre-arithmetic}. Note that this is not a direct corollary of the general Hasse principle of Theorem \ref{galoiscohomology-theorem-Hasse-principle}, since 
\end{proof}

\begin{remark}
\label{remark-genus-equivalent}
	Suppose $q$ and  $q'$ are in the same genus. Notice that since $q$ and  $q'$ are equivalent over $\mathbb{Z}_p$, then they are also equivalent over $\mathbb{Q}_p$ through extension of scalars. Then by Hasse principle, they are also equivalent over $\mathbb{Q}$. 
\end{remark}

\begin{proposition}
\label{proposition-bijection}
	Fix an integral quadratic form $(\Lambda,q)$ and let $G=\text{O}_q$ be its orthogonal group. For any $(\Lambda',q')$ in the genus of $q$, there exists, by definition, $\alpha\in \text{Isom}_{\hat{\mathbb{Z}}\times\mathbb{R}} (\Lambda, \Lambda')$ such that $q=\alpha^* q$. By the Hasse principle, there also exists $\beta\in \text{Isom}_{\mathbb Q} (\Lambda, \Lambda')$ such that $q=\beta^* q'$. The composition $\gamma = \beta^{-1}\circ \alpha$ is then an element of $G(\mathbb{A})$. 
	
	The coset of $\gamma$ in $G(\mathbb{Q})\backslash G(\mathbb{A})/G(\hat{\mathbb{Z}}\times \mathbb{R})$ does not depend on choices, and the map $q'\mapsto [\beta^{-1}\circ \alpha]$ induces an equivalence of groupoids\footnote{In other words, a bijection between equivalence classes, and an identification of automorphism groups (up to inner automorphism).}
    \begin{equation}\label{equation-bijection}
	    \left \{\text{genus of }q\right \} \longleftrightarrow G(\mathbb{Q})\backslash G(\mathbb{A})/G(\hat{\mathbb{Z}}\times \mathbb{R}).
    \end{equation}
\end{proposition}

\begin{proof}
	Since $q=\alpha^* q'$ and $q= \beta^* q'$, we get $q=\gamma^* q$, so $\gamma\in G(\mathbb{A})$. Any other isomorphism between $q'$ and $q$ over $\hat{\mathbb{Z}}\times \mathbb{R}$, it is given by $\alpha\circ \sigma$ for some $\sigma\in G(\hat{\mathbb{Z}}\times\mathbb{R})$. Similarly, any isomorphism between $q'$ and $q$ over $\mathbb{Q}$ is given by $\beta\circ \sigma'$ for some $\sigma'\in G(\mathbb{Q})$. So, the class of $\beta^{-1}\alpha$ in $Y:=G(\mathbb{Q})\backslash G(\mathbb{A})/G(\hat{\mathbb{Z}}\times \mathbb{R})$ is well-defined, defining a map $m$ from the genus of $q$ to the set $Y$.

    Let us prove that the map $m$ is a bijection of equivalence classes. For injectivity, suppose first that $m(\Lambda',q')$ is the coset of $1 \in G(\mathbb A)$. This means that, by choosing $\alpha$ and $\beta$ appropriately, we can ensure that $\alpha = \beta \in \text{Isom}_{\hat{\mathbb{Z}}\times\mathbb{R}} (\Lambda, \Lambda') \cap \text{Isom}_{\mathbb Q} (\Lambda, \Lambda') = \text{Isom}_{\mathbb{Z}}(\Lambda, \Lambda')$, hence $q' \overset{\mathbb Z}\sim q$. 
        
    The general injectivity statement reduces to this case, by noticing that an element $\beta$ as above gives rise to an isomorphism $\beta^*: G' \xrightarrow\sim G$ over $\mathbb Q$, where $G' = \text{O}_{q'}$, hence to a bijection (actually, equivalence of groupoids) between the corresponding double coset spaces $Y$ and $Y'$. Hence, for any two forms in the genus of $q$ with $m(\Lambda',q') = m(\Lambda'',q'')$, we can replace $q$ by $q'$ and apply the argument for $m(\Lambda'',q'')=1$.
	
    For surjectivity, any $\gamma \in G(\mathbb{A})$ defines a lattice $\Lambda_{\gamma}=\Lambda \otimes \mathbb{Q} \cap \gamma(\Lambda \otimes(\hat{\mathbb{Z}}\times \mathbb{R})) \subset \Lambda \otimes \mathbb{A}$. Note that $q|_{\Lambda_\gamma}$ takes values in $\mathbb Q\cap \hat{\mathbb{Z}}\times \mathbb{R}$, i.e., $(\Lambda_\gamma,q)$ is an integral quadratic lattice. Moreover, picking $\beta \in \text{GL}_{\Lambda}(\mathbb{Q})$ such that $\beta(\Lambda_\gamma)=\Lambda$, and setting $\alpha= \beta \gamma\in \text{GL}_{\Lambda}(\hat{\mathbb{Z}}\times \mathbb{R})$, we see that $(\Lambda_\gamma,q)$ corresponds to the class $[\gamma]\in Y$ under the above map --- hence, the map $m$ is surjective. 
	
	Finally, the automorphism group $G(\mathbb Z)$ of $(\Lambda,q)$ is the automorphism group of $1$ in the double coset space $Y$ (viewed now as a groupoid). By the same argument as above, using an element $\beta$ to replace $G$ by $G'$, the same applies to any form $(\Lambda',q')$ in the genus of $q$, i.e., $G'(\mathbb Z)$ is isomorphic (canonically up to inner automorphisms) to the stabilizer of a representative in the class $m(\Lambda',q')$.
\end{proof}



We now restrict our attention to (positive or negative) definite integral quadratic forms, so that the automorphism group $G(\mathbb Z)$ is finite (being a discrete subgroup in the compact Lie group $G(\mathbb R)$.

\begin{definition}
\label{definition-mass-quadratic-form}
    Given a definite quadratic form $q$, the {\it mass} of the genus of $q$, denoted as  $m(q)$, is the weighted count of isomorphism classes of forms in the genus, considered as a stack, i.e., 
    \[
	    m(q)=\sum_{q'\in X_q} \frac{1}{|\text{Aut} q'|}=\sum_{q'\in X_q} \frac{1}{|\text{O}_{q'}(\mathbb{Z})|},
    \]
    where $X_q$ denotes the set of isomorphism classes of elements in the genus of $q$.
\end{definition}


The next proposition relates the mass of a genus to the Tamagawa number $\tau(\text{SO}_q)$ of the special orthogonal group. 

\begin{remark}
 \label{remark-special-orthogonal-group}
For rings where $2$ is a unit, or in odd dimensions, the special orthogonal group is defined as the kernel of the determinant in $\text{O}_q$. In even dimensions and $2$ non-invertible, in order to obtain the correct definition (that is, the reductive group scheme corresponding to the appropriate root datum), one needs to define $\text{SO}_q$ as the kernel of the {\it Dickson morphism} $\text{O}_q\to \mathbb Z/2$, which in this case is surjective, even in characteristic $2$. The difference between the correct and the ``naive'' definition does not play any role in what follows, because the $\mathbb Z_2$-points of both are the same, but we will use the fact that $[\text{O}_q(\mathbb Z_2):\text{SO}_q(\mathbb Z_2)]=2$ in every case.
\end{remark}



\begin{proposition}
\label{proposition-SMSmassformula}
Let $q$ be a definite integral quadratic form in  $n$ variables, $n\geq 2$. The mass of the genus of $q$ is equal to 
\[
	m(q)=2^{-1}\frac{\tau(\text{SO}_q)}{\mu_{\text{Tam}}(\text{SO}_{q}(\hat{\mathbb{Z}}\times \mathbb{R}))}.
\]  
\end{proposition}
\begin{proof}
	Let $q'$ be any element in $X_q$, and let $\gamma\in Y:=G(\mathbb{Q})\backslash G(\mathbb{A})/G(\hat{\mathbb{Z}}\times \mathbb{R})$, where $G=\text{O}_q$, be the element corresponding to $q'$ under the bijection in Proposition \ref{proposition-bijection}. Then Proposition \ref{proposition-bijection} implies that $\text{O}_{q'}(\mathbb{Z})=G(\hat{\mathbb{Z}}\times \mathbb{R})\cap \gamma^{-1}G(\mathbb{Q})\gamma$ and thus we get 
	\begin{equation*}
		m(q)=\sum_{\gamma\in Y} \frac{1}{|G(\hat{\mathbb{Z}}\times \mathbb{R})\cap \gamma^{-1}G(\mathbb{Q})\gamma|}.
	\end{equation*}
	Let $\mu$ be any Haar measure on $G(\mathbb{A})$, then $\mu$ also induces a measure on $G(\mathbb{Q})\backslash G(\mathbb{A})$, which is invariant under the action of $G(\hat{\mathbb{Z}}\times\mathbb{R})$. Thus $G(\mathbb{Q})\backslash G(\mathbb{A})$ can be written as a union $\bigcup_{\gamma\in Y} O_{\gamma}$ where $O_{\gamma}$ is the orbit of $\gamma$ under the action of $G(\hat{\mathbb{Z}}\times\mathbb{R})$. Since each $O_{\gamma}$ can be identified with $(G(\hat{\mathbb{Z}}\times \mathbb{R})\cap \gamma^{-1}G(\mathbb{Q})\gamma)\backslash G(\hat{\mathbb{Z}}\times \mathbb{R})$, we get 
\begin{equation}
\label{equation-Oqformula}
\sum_{\gamma\in Y}\frac{1}{|G(\hat{\mathbb{Z}}\times \mathbb{R})\cap \gamma^{-1}G(\mathbb{Q})\gamma|} = \sum_{\gamma\in Y}\frac{\mu(O_{\gamma})}{\mu(G(\hat{\mathbb{Z}}\times \mathbb{R}))} = \frac{\mu(G(\mathbb{Q})\backslash G(\mathbb{A}))}{\mu(G(\hat{\mathbb{Z}}\times \mathbb{R}))}.
\end{equation}
	To compute (\ref{equation-Oqformula}), let us first consider the analogue of it by substituting the group scheme $G$ by its subscheme $\text{SO}_q$ and compute 
\begin{equation}\label{equation-SOqformula}
	\frac{\mu'(\text{SO}_q(\mathbb{Q})\backslash \text{SO}_q(\mathbb{A}))}{\mu'(\text{SO}_q(\hat{\mathbb{Z}}\times\mathbb{R}))}
\end{equation}
for $\mu'$ a Haar measure. Moreover, if we take $\mu'=\mu_{\text{Tam}}$ to be the Tamagawa measure, then the numerator becomes the Tamagawa number of $\text{SO}_q$, which we denote by $\tau(\text{SO}_q)$. Now compute (\ref{equation-Oqformula}) by comparing it with (\ref{equation-SOqformula}). Let $U\subset \mathbb{A}^{\times}$ be the subgroup containing such elements $u\in \mathbb{A}^{\times}$ that $u^2=1$, we then obtain an exact sequence 
\[
	1\rightarrow \text{SO}_q(\mathbb{A})\rightarrow G(\mathbb{A})\rightarrow U\rightarrow 1
\] 
where the map from $G(\mathbb{A})$ to $U$ is the determinant map. Let $\mu_{\text{Tam}}$ be the Haar measure on $\text{SO}_q(\mathbb{A})$ and $\mu''$ be a Haar measure on $U$, then we can construct a Haar measure $\mu$ on  $G(\mathbb{A})$ using $\mu_{\text{Tam}}$ and  $\mu''$ by setting 
\[
	\mu(W)=\int_{u\in U} \mu_{\text{Tam}}(\text{SO}_q(\mathbb{A})\cap \overline{u}^{-1}W)d\mu''
\] 
for $W\subset G(\mathbb{A})$ and $\overline{u}\in G(\mathbb{A})$ any element lying over $u$.
Then since $\mu$ is compatible with the other two Haar measures $\mu_{\text{Tam}}$ and $\mu''$, we get
\[
	\frac{\mu(G(\mathbb{Q})\backslash G(\mathbb{A}))}{\mu_{\text{Tam}}(\text{SO}_q(\mathbb{Q})\backslash\text{SO}_q(\mathbb{A}))}=\mu''(\{\pm 1\}\backslash U)=\frac{\mu''(U)}{2}. 
\] 
Similarly, let $V\subset U$ be the image of $\det|_{G(\hat{\mathbb{Z}}\times\mathbb{R})}$, then
 \[
	 \frac{\mu(G(\hat{\mathbb{Z}}\times \mathbb{R}))}{\mu_{\text{Tam}}(\text{SO}_q(\hat{\mathbb{Z}}\times \mathbb{R}))}=\mu''(V)=\frac{\mu''(U)}{|U/V|}.
\] 
Thus we get 
\[
	\frac{\mu(G(\mathbb{Q})\backslash G(\mathbb{A}))}{\mu(G(\hat{\mathbb{Z}})\times \mathbb{R})}= \frac{|U/V|\mu_{\text{Tam}}(\text{SO}_q(\mathbb{Q})\backslash \text{SO}_q(\mathbb{A}))}{2\mu_{\text{Tam}}(\text{SO}_q(\hat{\mathbb{Z}}\times \mathbb{R}))}= \frac{|U/V|\tau(\text{SO}_q)}{2\mu_{\text{Tam}}(\text{SO}_q(\hat{\mathbb{Z}}\times \mathbb{R}))}
\] 
Now, we have $|U/V| = 2^{k}$, where $k$ is the number of primes $p$ such that $\text{SO}_{q}(\mathbb{Z}_p)=\text{O}_{q}(\mathbb{Z}_p)$. Thus, we get
\[
	m(q)=\frac{\mu(G(\mathbb{Q})\backslash G(\mathbb{A}))}{\mu(G(\hat{\mathbb{Z}}\times \mathbb{R}))}=2^{k-1}\frac{\tau(\text{SO}_q)}{\mu_{\text{Tam}}(\text{SO}_q(\hat{\mathbb{Z}}\times \mathbb{R}))}.
\] 
Up to this point, the argument would apply, with obvious modifications, to any connected or disconnected reductive group $G$. Finally, we claim that for every prime $p$ we have $[\text{O}_q(\mathbb Z_2):\text{SO}_q(\mathbb Z_2)]=2$. This is immediate for $p\ne 3$ by the existence of an orthogonal basis for every quadratic lattice \cite[\S 92]{OMeara}. For $p=2$, see \cite[\S 93]{OMeara}, and also Remark \ref{remark-special-orthogonal-group}.
\end{proof}

\begin{remark}
\label{remark-SMS-formula}
The Smith--Minkowski--Siegel mass formula says that $\tau(\text{SO}_q)=2$, or, equivalently:
\begin{equation}
 \label{equation-SMSmassformula}
		m(q)=\frac{1}{\mu_{\text{Tam}}(\text{SO}_q(\hat{\mathbb{Z}}\times \mathbb{R}))}.
\end{equation}
Ultimately, this is a special case of Theorem \ref{theorem-general-weil}.
\end{remark}



[To add: calculation of $p$-adic densities.]




\section{Incarnations of the automorphic space: moduli of principal $G$-bundles}
\label{section-BunG}


Let $G$ be a (smooth) affine algebraic group over a field $\mathbb F$. 
By a \emph{(principal) $G$-bundle} over an $\mathbb F$-scheme $C$ we will mean a $G$-torsor $P\to C$ in the fpqc or \'etale topology, that is, a $G$-equivariant sheaf (or, equivalently by fpqc descent, a $G$-equivariant scheme) over $C$, such that there is a finitely presented, quasicompact cover, or an \'etale cover  $\tilde C\to C$, with a $G$-equivariant isomorphism
$$ P\times_C \tilde C \simeq G \times \tilde C.$$

That the two topologies give rise to the same objects follows from the smoothness of $G$ (and hence of any $G$-torsor), and the fact that smooth morphisms $X\to Y$ admit sections \'etale-locally. It is not, in general, true that an \'etale $G$-torsor is trivial Zariski-locally.



However, this is often true when $C$ is a curve. Let $C$ be a one-dimensional, reduced and irreducible scheme of finite type over $\mathbb F$. Let $k = \mathbb F(C)$ be the function field of the curve, $\mathbb A$ its ring of adeles, defined as the restricted tensor product, over all closed points $x$ of the curve, of the fields $k_x$, and $\mathcal O:= \prod_x \mathfrak o_x\subset \mathbb A$, the product of the associated stalks of rings. 





The set of isomorphism classes of $G$-bundles over $C$ will be denoted by $\text{Bun}_G(\mathbb F)$; it is the set of $\mathbb F$-isomorphism classes of a moduli stack $\text{Bun}_G$, which we will not define.


\begin{proposition}
 \label{proposition-BunG}
Assume that $H^1(k,G)=1$ and, for every finite extension $\mathbb F'/\mathbb F$, $H^1(\mathbb F',G)=1$. Then, 
there is a canonical isomorphism of \emph{groupoids of sets} $[G]/G(\mathcal O) \leftrightarrow \text{Bun}_G(\mathbb F)$, such that, if a $G$-bundle $P$ corresponds to the class of $(g_v)_v$, which can be assumed to be equal to $1$ for every $v\in U$, for some open dense $U\subset C$, then there are trivializations $t_U: P|_U\xrightarrow\sim G\times U$ and $t_v: P|_{\text{Spec} \mathfrak o_v} \xrightarrow\sim G\times \text{Spec} \mathfrak o_v$ for $v\notin U$, such that $t_U \circ t_v^{-1}|_{\text{Spec} k_v} = g_v$.
\end{proposition}

``Groupoid of sets'' means (small) categories where all morphisms are isomorphisms; such a category is equivalent to a set, where every point is equipped with a group of automorphisms.


\begin{proof}
Citing \cite[112593]{Mathoverflow}---look there for more details and links to sources:

Since $H^1(k,G)=1$, any $G$-torsor is trivial over the generic point of $C$, hence over a nonempty upen $U\subset C$. Fix such an open set and an isomorphism $P|_{U} \simeq G\times U$, i.e.\ a section $\rho: U \to P$. 

On the other hand, for every $v\in C$, consider the restriction of $P$ to the formal neighborhood $D_v = \text{Spec} \mathfrak o_v$ at $v$. The residue field $\mathbb F(v)$ is a finite extension $\mathbb F'$ of $\mathbb F$, and since $H^1(\mathbb F',G)=1$, the restriction to $P$ over the special fiber is trivial, i.e., admits a section $\text{Spec} \mathbb F' \to P$. Since $P$ is formally smooth, this extends to a section $\sigma_v: D_v \to P$, i.e., $P$ is trivial over $D_v$; fix such a section $\sigma_v$, for every $v \notin U$. 
 
Then, on the intersection $U\cap D_v = \text{Spec} k_v$, we have the restrictions of two sections $\rho$ and $\sigma_v$, and thus there is a $g_v\in G(k_v)$ such that $g_v\cdot \sigma_v = \rho$. Set $g_v=1$ for $v\in U$; the collection $(g_v)_v$ gives an element of $G(\mathbb A)$, which depends on choices made. All different choices for $\rho$ (possibly for different $U$) are of the form $G(k)\rho$, and for $\sigma_v$ of the form $G(\mathfrak o_v) \sigma_v$. Thus, independently of choices, the $G$-bundle $P$ gives rise to an element of $G(k)\backslash G(\mathbb A)/G(\mathcal O)$.

Vice versa, descent for the fpqc cover $\text{Spec}(k) \sqcup \text{Spec} \mathfrak o_v \to \text{Spec} \mathfrak o_{(v)}$ (where $\mathfrak o_{(v)}\subset k$ is the local ring at $v$) shows that the category of $G$-torsors over $\text{Spec}(\mathfrak o_{(v)})$ is equivalent to the category of data $(P_v, \tau_v)$, where $P_v$ is a $G$-torsor over $\mathfrak o_v$, and $\tau_v$ is a descent datum from its generic fiber to the trivial bundle over $k$ --- equivalently, a section of $P_v$ over $\text{Spec}(k_v)$. 

If two $G$-bundles $P_1, P_2$ give rise to the same class in $[G]/G(\mathcal O)$, and we represent them as the trivial bundle over an open set $U$ (which we can assume to be the same for both) and data $(P_{i,v}, \tau_{i,v})$ for $v\in S:= C\smallsetminus U$, the fact that the classes in $[G]/G(\mathcal O)$ are the same means that there are isomorphisms $r_v: P_{1,v}\xrightarrow\sim P_{2,v}$ such that $r_v\circ \tau_{1,v} = \tau_{2,v}$. By the equivalence of categories, these data give rise to an isomorphism $r:P_1\xrightarrow\sim P_2$. A similar argument shows that an automorphism $r$ of a $P$-bundle presented as above is the same as an element $r_U \in G(\mathfrak o_S)$ (=a section of $G$ over $U$) and sections $r_v \in G(\mathfrak o_v)$ such that $r_v = g_v^{-1} r g_v$, i.e., $r\in G(k)\cap (g_v)_v G(\mathcal O) (g_v)_v^{-1}$, which is the stabilizer of the corresponding point in $[G]/G(\mathcal O)$.

Finally, any class of $G(k)\backslash G(\mathbb A)/G(\mathcal O)$ can be represented by an element $(g_v)_v$ which is equal to $1$ at the points of an open subset $U\subset C$, and then we can form an associated $G$-bundle by \emph{modification} of the trivial vector bundle over the points of $C\smallsetminus U$, that is, by glueing $G\times U$ to $G\times \text{Spec}(\mathfrak o_v)$ according to $g_v$ over $\text{Spec}(k_v)$. 
\end{proof}



\begin{remark}
\label{remark-vanishing-cohomology}
The condition $H^1(k,G)=1$ is satisfied if $\mathbb F$ is algebraically closed and $G$ is connected reductive, by results of Tsen, and Springer ($+\epsilon$); it is satisfied when $\mathbb F$ is finite and $G$ is semisimple, simply connected, by Harder's proof of the Hasse principle \ref{galoiscohomology-theorem-Hasse-principle}. The condition $H^1(\mathbb F',G)$ holds, trivially, when $\mathbb F = \mathbb C$, and by Lang's theorem \ref{galoiscohomology-theorem-Lang} when $\mathbb F$ is finite and $G$ is connected.

On the other hand, the $\mu_n$-torsor $\mathbb G_m\xrightarrow{~^n}\mathbb G_m$ is not locally trivial in the Zariski topology, for  any $n\ge 2$. Moreover, over higher-dimensional bases (e.g., surfaces), even for simply connected semisimple groups, there are \'etale torsors which are not locally trivial in the Zariski topology.
\end{remark}

\begin{remark}
 \label{remark-automorphism-group}
Note that the $G$-automorphism group of a $G$-bundle makes sense as a group scheme $G'$ over the curve, and is an inner form of $G$ (compare with \ref{reductiveforms-definition-pure-inner-form}). The automorphisms appearing in Proposition \ref{proposition-BunG} are simply the \emph{global sections} of $G'$.
\end{remark}

It is interesting to discuss the isomorphism of Proposition \ref{proposition-BunG} in the case of $G= \mathrm{GL}_n$. In this case the category of $G$-bundles is equivalent to the category $\mathrm{Vect}_n(C)$ of rank $n$ vector bundles via the functor $P\mapsto E = V\times^G P$, where $V$ is the standard representation of $\mathrm{GL}_n$, with inverse $E \mapsto$ the frame bundle of $E$. In the rest of this subsection, we prove that points in a neighborhood of cusps corresponds to unstable vector bundles through this identification. [we ignore the automorphisms, at least for now.]
In order to understand the asymptotic behavior of corresponding vector bundles, we would like to translate the situation to the boundary degeneration of $[G]$. For simplicity, we will restrict to the case $n=2$. For general $n$, while everything except Proposition \ref{proposition-unstable-cusp} holds mutatis mutandis, for the final result we will need to consider $P$-cusps for all conjugate class of parabolic subgroups, not only the Borel subgroup. First note the following:
\begin{lemma}
\label{lemma-vanishing-cohomology-borel-and-cartan}
Let $\mathbb F = \mathbb F_q$, and let $H$ be one of $\mathrm{GL}_2$, its chosen Borel subrgoup $B$, its unipotent radical $\mathbb G_a$, or its universal Cartan group scheme $\mathbf A\cong (\mathbb G_m)^2$. 
Then the conditions $H^1(k, H) = 1$ and $H^1(\mathbb F', H)=1$ (for $\mathbb F'$ any finite extension of $\mathbb F$) in Proposition \ref{proposition-BunG} are satisfied. 
In particular, there are canonical isomorphisms $[H]/H(\mathcal O)\leftrightarrow \mathrm{Bun}_H(\mathbb F)$.
\end{lemma}
\begin{proof}
Remark \ref{remark-vanishing-cohomology} applies directly to $H^1(\mathbb F', \mathrm{GL}_2)=1$. When $H=\mathbb G_a$ or $\mathbb G_m$, by Hilbert's theorem 90 we have $H^1(k, H)=1$. The cohomology long exact sequence (of pointed sets) for  $1\to \mathbb G_a\to B\to \mathbf A\to 1$ tells us that all the first cohomology sets in question are trivial.
\end{proof}

Since $B$ is the stabilizer of a complete flag $V_\bullet = (0=V_0\subset V_1\subset V_2=V)$, the category of $B$-bundles is equivalent to the category $\mathrm{Flag}_2(C)$ of rank $2$ complete flag bundles via $P\mapsto E_\bullet = V_\bullet \times^B P$. Similarly, since $\mathbf A\cong \mathbb G_m\times\mathbb G_m$, the category of $\mathbf A$-bundles is equivalent to the category $\mathrm{Vect}_1 (C)\times \mathrm{Vect}_1 (C)$. Note that the set of isomorphism classes of $\mathrm{Vect}_1 (C)$ is a group with respect to the tensor product, which is denoted by $\mathrm{Pic}(C)$. The following lemma relates these bundle interpretations of double-cosets:
\begin{lemma}
\label{lemma-flag-graded}
Through the isomorphisms of Proposition \ref{proposition-BunG},
\begin{enumerate}
\item the map $f: [B] /B(\mathcal O)\to [G]/G(\mathcal O)$ induced by the inclusion $B\hookrightarrow G$ corresponds to the map $\mathrm{fgt}: \mathrm{Flag}_2(C) \simeq\mathrm{Bun}_B(\mathbb F) \to \mathrm{Bun}_G(\mathbb F)\simeq \mathrm{Vect}_2(C)$ which sends a flag bundle $E_\bullet$ to its top filtration $E=E_2$.
\item the map $g: [B]/B(\mathcal O)\to [\mathbf A]/\mathbf A(\mathcal O)$ induced by the quotient $B\to \mathbf A$ corresponds to the map $\mathrm{gr}: \mathrm{Flag}_2(C)\simeq \mathrm{Bun}_B(\mathbb F)\to \mathrm{Bun}_{\mathbf A}(\mathbb F)\simeq \mathrm{Pic}(C)\times \mathrm{Pic}(C)$ which sends a flag bundle $E_\bullet = (0\subset E_1\subset E)$ to its associated graded bundle $\mathrm{gr}_\bullet(E_\bullet) = (E_1, E/E_1)$.
\end{enumerate}
\end{lemma}
\begin{proof}
The isomorphism of Proposition \ref{proposition-BunG} is given by seeing a double-coset as gluing data for trivial bundles on a fixed covering. Therefore $f$ corresponds to the map $G\times^B (-): \mathrm{Bun}_B(C)\to \mathrm{Bun}_G(C)$. Passing to vector bundles, $V\times^G G\times^B P\cong V\times^B P$ is the top filtration of the flag bundle $V_\bullet\times^B P$. 
Similarly, the map $B\to \mathbf A$ induces, on flag bundles, the map $E_\bullet = V_\bullet \times^B P\mapsto (\mathrm{gr}_\bullet V_\bullet) \times^B P \cong \mathrm{gr}_\bullet E_\bullet$. 
\end{proof}

For $\mathbb{G}_m = \mathrm{GL}_1$, we can write down the isomorphism more explicitly as follows: 
Let $\mathrm{Div}(C)$ denote the divisor group of $C$, i.e., the free abelian group generated by the closed points of $C$. The normalized discrete valuation $\mathrm{val}_x: k_x^\times \to \mathbb{Z}$ with the kernel $\mathfrak o_x^\times$ induces the map $\mathrm{val}: \mathbb A^\times \to \mathrm{Div}(C)$ between their restricted products. 
Dividing by the kernel we get a canonical isomorphism $\mathbb A^\times /\mathcal O^\times \xrightarrow{\cong} \mathrm{Div}(C)$. The elements in the image of $k^\times \subset \mathbb A^\times$ in $\mathrm{Div}(C)$ are called principal divisors, and we have an exact sequence $k^\times \to \mathrm{Div}(C)\twoheadrightarrow \mathrm{Pic}(C)\to 0$. So the valuation gives the isomorphism $[\mathrm{GL}_1]/\mathrm{GL}_1(\mathcal O)\cong \mathrm{Pic}(C)$.

Now we introduce the notion of slope-stability for vector bundles over a curve. See \cite[Chapter 5]{LePotier} for more details.
\begin{definition}
\label{definition-slope-stability}
\begin{enumerate}
\item For any closed point $x\in C$ we define $\mathrm{deg}(x) = 1$, and linearly extend it to the {\it degree} homomorphism $\mathrm{deg}: \mathrm{Div}(C)\to \mathbb Z$ . By the product formula of valuations the degree of a principal divisor is $0$, so it factors through $\mathrm{Pic}(C)\to \mathbb Z$, which we also denote by $\deg$. 
\item More generally, we define the {\it degree of a vector bundle} $E$ as the degree of its determinant line bundle: $\mathrm{deg} E = \mathrm{deg} \bigl(\bigwedge^{\mathrm{rk} E} E\bigr)$. 
\item For a nonzero vector bundle $E$, we call the rational number $\mu(E) = \frac{\mathrm{deg} (E)}{\mathrm{rk} (E)}$ the {\it slope} of $E$.
\item A vector bundle $E$ is said to be {\it semistable} if for any nonzero subbundle $F\subset E$, we have $\mu(F)\leq \mu(E)$, and {\it unstable} otherwise.
\end{enumerate}
\end{definition}

\begin{remark}
\label{remark-filtration}
\begin{enumerate}
\item If we have a short exact sequence $0\to E'\to E\to E''\to 0$, then the canonical isomorphism $\bigwedge^{\mathrm{rk} E} E\cong \bigl(\bigwedge^{\mathrm{rk} E'} E'\bigr)\otimes \bigl(\bigwedge^{\mathrm{rk} E''} E''\bigr)$ exhibits that $\mathrm{deg} E = \mathrm{deg} E'+\mathrm{deg} E''$.
\item The slope can be defined more generally for a coherent sheaf $F$ on $C$ by decomposing it into a direct sum of a vector bundle and a sheaf with finite support. The definition of semi-stability remains equivalent if we replace `nonzero subbundle' by `nonzero coherent subsheaf.'
\item For any subbundle $F\subset E$, consider the point $p_F = (\mathrm{rk} (F), \mathrm{deg} (F)) \in \mathbb Z^2$ on a plane. Then the slope $\mu(F)$ is literally the slope of the segment $0p_F$. By the additivity of $\mathrm{rk}$ and $\mathrm{deg}$ for short exact sequences, we see that the slope of the segment $p_Fp_E$ is the slope $\mu(E/F)$ of the quotient. Considering the convex hull of $\{p_F\mid F\subset E\}$ and taking the upper edges $0p_{F_1}$, $p_{F_1}p_{F_2}$,\ldots, $p_{F_{k-1}}p_{F_k}$, it can be proved that there exists a unique filtration $0\subset F_1\subset F_2\subset \cdots \subset F_k = E$ by subbundles that satisfies the following:
\begin{enumerate}
\item $\mathrm{gr}_i = F_i/F_{i-1}$ is semistable, 
\item $\mu(\mathrm{gr}_1)> \mu(\mathrm{gr}_2)>\cdots >\mu(\mathrm{gr}_k)$. 
\end{enumerate}
This filtration is called the {\it Harder-Narasimhan filtration}. 
\item %If $E$ and $F$ are two semi-stable bundles on $C$ and $\mathrm{Hom}(F, E)\neq 0$, then we have $\mu(E)\leq \mu(F)$. In particular, if 
Let $\mu$ be a fixed rational number and consider the full subcategory $\mathcal C(\mu)$ of the abelian category $\mathrm{Coh}_C$ of coherent sheaves spanned by semistable vector bundles of slope $\mu$. Then $\mathcal C(\mu)$ is closed under kernel, cokernel, and extensions. In particular, in contrast with the category of all vector bundles, the category $\mathcal C(\mu)$ is abelian. 
\end{enumerate}
\end{remark}

Now back to our context, note that the composition
\[\mathbb A^\times \twoheadrightarrow [\mathrm{GL}_1]/\mathrm{GL}_1(\mathcal O)\xrightarrow{\mathrm{val}}\mathrm{Pic}(C)\xrightarrow{\mathrm{deg}} \mathbb Z\] is given by $-\log$ of the adelic absolute value function. 

\begin{proposition}\label{proposition-unstable-cusp}
The points in $[\mathrm{GL}_2]$ whose image in $[\mathrm{GL}_2]/\mathrm{GL}_2(\mathcal O)$ corresponds to an unstable vector bundles forms a neighborhood of the ($B$-)cusp. 
\end{proposition}
\begin{proof}
The rank $2$ vector bundle $E$ is unstable iff there exists a complete flag $0\subset F\subset E$ such that $\mu(F)> \mu(E/F)$, or equivalently, $\mathrm{deg}(F)> \mathrm{deg}(E/F)$. Considering $\mathrm{Vect}_2(C)\xleftarrow{\mathrm{fgt}} \mathrm{Flag}_2(C)\xrightarrow{\mathrm{gr}} \mathrm{Pic}(C)^{\oplus 2}\xrightarrow{\mathrm{deg}^{\oplus 2}} \mathbb Z^{\oplus 2}$, the unstable loci of $\mathrm{Vect}_2(C)$ is $\mathrm{fgt}\bigl((\mathrm{deg}^{\oplus 2}\circ\mathrm{gr})^{-1}\{(a, b)\in \mathbb Z^{\oplus 2} \mid a>b \}\bigr)$. Interpreting through Lemma \ref{lemma-flag-graded}, this diagram is isomorphic to $[G]/G(\mathcal O)\xleftarrow{f} [B]/B(\mathcal O) \xrightarrow{g} [\mathbf A]/\mathbf A(\mathcal O) \xrightarrow{-\log \lvert-\rvert^{\oplus 2}} \mathbb Z^{\oplus 2}$. Therefore the preimage $U$ of $\{(a, b)\in \mathbb Z^{\oplus 2} \mid a>b \}$ in $[B]/B(\mathcal O)$ is the set of points represented by an upper-triangular matrix $(a_{ij})$ such that $-\log \lvert a_{11} \rvert> -\log \lvert a_{22}\rvert$. 
Now recall from Theorem \ref{theorem-reduction-theory-split} that the map $B(k)\backslash G(\mathbb A) \xrightarrow{\pi_G} [G]$ is injective in a neighborhood of the cusp, and the sets $V_\epsilon = \{(a_{ij}) \mid -\log\lvert a_{11}/a_{22}\rvert > -\log \epsilon \}$ (in the same basis representation) forms a basis of neighborhoods of the cusp in $B(k)\backslash G(\mathbb A)$. By Iwasawa decomposition $G(\mathbb A) = B(\mathbb A)K$, where $K= G(\mathcal O)$ in our case, the map $f$ factors into $[B]/B(\mathcal O)\xrightarrow{\cong} B(k)\backslash G(\mathbb A)/G(\mathcal O) \xrightarrow{\pi_G} [G]/G(\mathcal O)$. Now we conclude by observing that the above set of unstable locus $U$ is the image of $V_1$. 
\end{proof}


\section{Incarnations of the automorphic space: locally symmetric spaces and Shimura varieties}
\label{section-locally-symmetric-Shimura}

\subsection{Locally symmetric spaces}
\label{subsection-locally-symmetric}

\begin{definition}
 \label{definition-symmetric}
A {\it Riemannian symmetric space} is a pair $(M,g)$, where $M$ is a (connected)\footnote{``Connected'' is not always part of the definition, but we will include it, for convenience.} manifold, and $g$ is a Riemannian metric on $M$, with the property that for every $x\in M$ there is an isometry $s_x:M\to M$, having $x$ as an isolated fixed point, and acting by $-1$ on the tangent space of $x$. 
\end{definition}


\begin{lemma}
 \label{lemma-symmetric-homogeneous}
If $(M,g)$ is a connected Riemannian symmetric space, then it is geodesically complete, the Lie group $G$ of isometries of $M$ acts transitively on $M$, and the stabilizer of any point $x\in M$ is a compact subgroup.
\end{lemma}

Notice that this implies that the identity component $G^0$ of the Lie group already acts transitively.

\begin{proof}
 \cite[Lemma 1.5 and Proposition 1.11]{Milne-Shimura}.
\end{proof}


Let $G$ be a real reductive algebraic group. By Theorem \ref{reductiveforms-theorem-Cartan-involution-exists}, the group $G(\mathbb R)$ admits a unique, up to conjugacy, Cartan involution.
Let $X$ be the set of its Cartan involutions, considered as a homogeneous manifold under the action of $G(\mathbb R)$: $X\simeq G(\mathbb R)/K$, where $K$ is the fixed-point subgroup of a Cartan involution $\theta$. 

\begin{proposition}
 \label{proposition-Riemannian-metric-GmodK}
Assume that $G$ is real semisimple. The space $X$ of Cartan involutions of $G$ admits a canonical $G(\mathbb R)$-invariant Riemannian metric $g$, described as follows: Let $\theta\in X$ be a Cartan involution, with corresponding Cartan decomposition (Definition \ref{reductiveforms-definition-Cartan-decomposition-involution}), $\mathfrak g(\mathbb R)= \mathfrak k \oplus \mathfrak p$, identifying the tangent space $T_\theta X \simeq \mathfrak p$. Then, the restriction of $g$ to $T_\theta X$ is the Killing form of $\mathfrak g$, restricted to $\mathfrak p$. This Riemannian structure has negative sectional curvature. 
\end{proposition}

\begin{proof}
See \cite[\S 5.4]{Paradan}.
\end{proof}



\begin{definition}
 \label{definition-symmetric-space-of-reductive-group}
The {\it symmetric space of a real reductive group} $G(\mathbb R)$ is the set $X$ of its Cartan involutions.
\end{definition}

The symmetric space of $G(\mathbb R)$ can be considered as a Riemannian symmetric space under any $G(\mathbb R)$-invariant Riemannian metric. Such a metric is the combination of a multiple of the Killing form of Proposition \ref{proposition-Riemannian-metric-GmodK} on each of the simple factors, and the Euclidean metric on the symmetric space of its center. 


\begin{definition}
 \label{definition-locally-symmetric-space}
A {\it Riemannian locally symmetric space} is a Riemannian manifold whose universal cover is a symmetric space.
\end{definition}


\begin{remark}
 \label{remark-locally-symmetric-of-G}
Let $G$ be a reductive algebraic group over a number field $k$, $[G]$ its automorphic space, $K_f$ an open compact subgroup of the finite adeles, and $K_\infty$ a maximal compact subgroup of $G(k_\infty)$ (unique up to conjugation, by Theorem \ref{reductiveforms-theorem-Cartan-involution-exists}). 

By Remark  \ref{remark-Ginfty-orbits}, the quotient $[G]/K_f K_\infty$ can be written as a finite disjoint union 
 $$ \bigsqcup_i \Gamma_i\backslash X,$$
 where $X$ is the symmetric space of $G(k_\infty)$, and the $\Gamma_i$'s are congruence subgroups. The subgroups $\Gamma_i$ act with finite stabilizers on $X$ (because they are discrete, and stabilizers of points on $X$ are compact), and taking $K_f$ small enough, they act properly discontinuously, so that $\Gamma_i\backslash X$ has the natural structure of a manifold with universal cover $X$. Thus, for $K_f$ small enough, $[G]/K_f K_\infty$ has a natural structure of locally symmetric space.
\end{remark}






\subsection{Hermitian locally symmetric spaces}
\label{subsection-hermitian-symmetric}

There are instances where the space $G_\infty/K_\infty$ of the previous subsection has more structure, that of a \emph{Hermitian symmetric space}. 

\begin{definition}
 \label{definition-hermitian-symmetric}
A {\it Hermitian symmetric space} is a pair $(M,g)$, where $M$ is a complex manifold, and $g$ is a Hermitian metric on $M$, with the property that for every $m\in M$ there is an isometry $s_x:M\to M$, having $m$ as an isolated fixed point, and acting by $-1$ on the tangent space of $m$. 

A {\it Hermitian symmetric domain} is a Hermitian symmetric space which, as a complex manifold, is isomorphic to a bounded open subset of $\mathbb C^n$. 
\end{definition}

\begin{remark}
 \label{remark-Bergman-metric}
For a Hermitian symmetric domain realized as a bounded open $U\subset \mathbb C^n$, the metric on $U$ is the {\it Bergman metric}, \cite[Theorem 1.3]{Milne-Shimura}. There is also another way to define Hermitian symmetric domains, as {\it Hermitian symmetric spaces of noncompact type}, \cite[\S 1]{Milne-Shimura}.
\end{remark}


\begin{lemma}
 \label{lemma-hermitian-homogeneous}
If $(M,g)$ is a hermitian symmetric domain, and $G$ is the Lie group of its isometries as a Riemannian manifold, then $G^0$ acts by holomorphic automorphisms. In particular, by Lemma \ref{lemma-symmetric-homogeneous}, $M$ is homogeneous, with compact stabilizers, under the group of its Hermitian automorphisms.
\end{lemma}

\begin{proof}
 \cite[Proposition 1.6]{Milne-Shimura}.
\end{proof}

From now on, ``automorphisms'' of a Hermitian symmetric domain will mean ``Hermitian automorphisms'', i.e., holomorphic isometries.
The Hermitian structure upgrades the $\pm 1$-symmetry at each point to an $S^1(=U_1)$-symmetry:

\begin{lemma}
 \label{lemma-S1-symmetry}
If $(M,g)$ is a Hermitian symmetric domain with group $G$ of holomorphic isometries, then for every $x\in M$ and every $z\in \mathbb C^1$ there is an automorphism $s_{x,z}$ of $M$, fixing $x$ and acting by $z$ on its tangent space.
\end{lemma}

\begin{proof}
 \cite[Theorem 1.9]{Milne-Shimura}.
\end{proof}


In particular, $s_{x,-1}$ is the automorphism $s_x$ of the symmetric structure. Another way to phrase this lemma is that there is a homomorphism $U_1\to G_x$, acting by the tautological character on the tangent space $\mathfrak g/\mathfrak g_x$ (which has a complex structure). 

\begin{lemma}
 \label{lemma-cocharacter-in-center}
The image of the homomorphism $U_1\to G_x$ lies in the center of $G_x$.
\end{lemma}

\begin{proof}
The group $G_x$ acts by holomorphic isometries on $M$, hence by complex linear automorphisms of the tangent space $T_x M$. Hence, its action on $T_x M$ commutes with the action of $U_1$; but an element in the image of $U_1\subset G_x^0$ is completely determined by its action on the tangent space.
\end{proof}



For our purposes, we want a realization of $G$ in terms of algebraic groups.

\begin{lemma}
 \label{lemma-hermitian-automorphisms-algebraic}
Let $(M,g)$ be a hermitian symmetric domain with automorphism (Lie) group $A$. Then, there is a unique connected, adjoint algebraic subgroup $G$ of $\text{GL}(\mathfrak a)$ over $\mathbb R$ such that $A^0 \xrightarrow\sim G(\mathbb R)^0$ under the adjoint representation.
\end{lemma}

\begin{proof}
 \cite[Proposition 1.7]{Milne-Shimura}.
\end{proof}

Thus, we can identify $M$ with the real points of an algebraic symmetric space $G/G_x$ over $\mathbb C$.
Every representation of a compact group is algebraic, so the homomorphism $s_x: U_1(\mathbb R) \to G_x(\mathbb R)$ comes from an algebraic morphism: $U_1 \to G_x$. Base-changing to $\mathbb C$, we obtain a cocharacter $\mathbb G_m \to G_{x,\mathbb C}$, which acts on the complexification $\mathfrak g_{\mathbb C}/\mathfrak g_{x,\mathbb C}$ by the characters $z\mapsto z^{\pm 1}$. Since the image lies on the center of $G_x$ (Lemma \ref{lemma-cocharacter-in-center}), it acts trivially on $\mathfrak g_{x,\mathbb C}$. 

\begin{definition}
 \label{definition-minuscule-weight}
Let $\mathfrak g$ be a semisimple Lie algebra over an algebraically closed field, and $\mathfrak h\subset \mathfrak g$ a Cartan subalgebra. A {\it minuscule coweight} is a coweight $\mu\in \mathfrak h$ such that for every root $\alpha$ we have $\left< \alpha, \mu\right> \in \{ -1, 0, 1\}$. Similarly, replacing roots by coroots one defines a {\it minuscule weight}.
\end{definition}

\begin{remark}
 \label{remark-minuscule-coweight}
Minuscule weights have the following representation-theoretic interpretation: An integral, dominant (with respect to some base of the root system --- can always assume by Weyl translation) weight $\mu$ is minuscule if and only if the only weights appearing in the associated irreducible highest weight module $V_\mu$ are Weyl group-translates of $\mu$, and zero. This follows directly from the Weyl character formula.

Minuscule coweights are relatively rare, and so are Hermitian symmetric domains. In the Langlands program, certain general constructions over function fields (Drinfeld's shtukas) that depend on an irreducible representation/dominant weight for the dual group (= coweight for $G$), only have known (partial) analogs (Shimura varieties) over number fields when the weight is minuscule.
\end{remark}


\begin{theorem}
 \label{theorem-classification-hermitian}
The map that assigns to pointed, \emph{connected} Hermitian symmetric domain $(M,g,x)$ (i.e., a connected Hermitian symmetric domain $(M,g)$ and a point $x\in M$) the pair $(G,s_x)$, where $G$ is the real algebraic group such that $G(\mathbb R)^0 = \text{Aut}(M,g)$ (Lemma \ref{lemma-hermitian-automorphisms-algebraic}) and $s_x:U_1\to G$ is the $S^1$-symmetry fixing $x$ (Lemma \ref{lemma-S1-symmetry}), is an equivalence between the groupoids of pointed connected Hermitian symmetric domains and pairs $(G,s)$ consisting of a real adjoint algebraic group $G$ and a homomorphism $s: U_1\to G$ such that:
\begin{itemize}
 \item $s$ is minuscule, i.e., its complexification is a minuscule cocharacter;
 \item $\text{Ad}(s(-1))$ is a Cartan involution for $G$;
 \item no simple factor of $G$ is compact; equivalently, $\text{Ad}(s(-1))$ does not project to $1$ on any simple factor of $G$. 
\end{itemize}
The inverse functor assigns to such a pair $(G,s)$ the set $M$ of $G(\mathbb R)^0$-conjugates of $s$, which has a unique structure of a Hermitian symmetric domain such that $s$, as a homomorphism, is the $S^1$-symmetry at $s$, as a point of $M$.
\end{theorem}


\begin{proof}
  \cite[Theorem 1.21]{Milne-Shimura}.
\end{proof}


\begin{definition}
 \label{definition-hermitian-locally-symmetric-space}
A {\it Hermitian locally symmetric space} is a Hermitian manifold whose universal cover is a Hermitian symmetric space.
\end{definition}

\begin{remark}
  \label{remark-hermitian-locally-symmetric-of-G}
Let $G$ be a reductive group over a number field. By Remark  \ref{remark-locally-symmetric-of-G}, the quotient $[G]/K_f K_\infty$  of the automorphic space is naturally a locally symmetric space (for $K_f$ small enough). If $G(k_\infty)$ admits a homomorphism $s:U_1\to G(k_\infty)$ satisfying the conditions of Theorem  \ref{theorem-classification-hermitian}, this quotient becomes a Hermitian locally symmetric space. {\it Shimura varieties} are (inverse) limits of such spaces, as $K_f\to 1$. Of course, one needs to justify the term ``varieties'', which is outside the current scope of these notes. 

\end{remark}



\subsection{Variation of Hodge structures}
\label{subsection-variation-Hodge}

In this subsection, we present a moduli description of Hermitian symmetric domains, following Milne \cite{Milne-Shimura}.

\begin{definition}
 \label{definition-Hodge}
 A (pure) {\it Hodge decomposition} of a real vector space $V$ is a decomposition
$$
V(\mathbb C)= \bigoplus_{p,q\in \mathbb Z} V^{p,q}
$$
such that $V^{q,p}$ is the complex conjugate of $V_{p,q}$. A (pure) {\it Hodge structure} is a real vector space together with a Hodge decomposition. For each integer $n$, the subspace $\bigoplus_{p+q=n}V^{p,q}$ of $V(\mathbb C)$ is stable under complex conjugation, and so it is defined over $\mathbb R$, i.e., there is a subspace $V_n$ of $V$ such that
$$
V_n(\mathbb C)=\bigoplus_{p+q=n}V^{p,q}.
$$
Then $V=\bigoplus_n V_n$ is called the {\it weight decomposition} of $V$. If $V=V_n$, then $V$ is said to have weight $n$. Let $V,W$ be two Hodge structures. A {\it morphism of Hodge structures} is a linear map $V \to W$, sending $V^{p,q}$ to $W^{p,q}$.
\end{definition}

\begin{remark}
 \label{remark-Hodge-structures}
 This definition comes from the fact that for a compact complex manifold admitting a K$\rm \ddot a$hler metric, we can always factor its cohomology group as
$$
H^n(X, \mathbb C)= \bigoplus _{ p+q=n}H^q(X, \Omega^p_X).
$$
Note that given a Hodge structure $V$, if we let $d(p,q)= \text{dim}_\mathbb C V^{p,q}$, then $V^{p,q}$ naturally corresponds to a point in the Grassmannian $G_{d(p,q)}(V(\mathbb C))$. Hence $V$ corresponds to a point in $\prod_{p,q:d(p,q)\ne 0} G_{d(p,q)}(V(\mathbb C))$.
\end{remark}

There are two other ways to give a Hodge structure to a real vector space. Given a Hodge structure $V$ of weight $n$, we can assign to $V(\mathbb  C)$ the {\it Hodge filtration}
$$
F^ \bullet : \cdots \supseteq F^p \supseteq F^{p+1} \supseteq \cdots,
$$
where $F^p = \bigoplus _{r \geq p} V^{r,n-r}$. Then, the Hodge structure can be recovered as $V^{p,q}=F^p \cap \overline{F^q}$. The Hodge filtration satisfies the axioms $F^p \cap \overline{F^{n+1-p}} = 0$ and $F^p \oplus \overline{F^{n+1-p}} = V(\mathbb C)$; vice versa, these axioms ensure that the filtration comes from a pure Hodge structure.

The Hodge filtration is, in some sense, a more natural object to consider, as it generalizes to a description of \emph{mixed Hodge structures}, which can also be associated to singular or non-proper varieties.

In this way, a Hodge structure on $V$ with $d(p,q)= \text{dim}_\mathbb C V^{p,q}$ corresponds to a flag $F^\bullet$ of $V(\mathbb C)$ satisfying $d_p=\text{dim}_\mathbb C F^p= \sum_{r \ge p} d(r,n-r)$.  Equivalently, it corresponds to a point in the flag variety $G_ \mathfrak d(V(\mathbb C)) $, where $\mathfrak d= (d_1,\cdots,d_p,\cdots)$.

Another way to give a Hodge structure is related to the represention of the {\it Deligne torus} $\mathbb S$, which is defined to be the restriction of scalars $\rm Res_{\mathbb C/ \mathbb R} \mathbb G_m$, as a linear algebraic group over $\mathbb R$.

\begin{lemma}
 \label{lemma-Deligne-torus}
  For any $\mathbb R-$ algebra $A$, $\mathbb S(A)\cong \{(a,b)\in A \times A| a^2+b^2 \ne 0\} $, with multiplication given by $(a,b)\cdot (a',b')=(aa'-bb',ab'+a'b)$.
\end{lemma} 

\begin{proof}
We can construct the following isomorphism, 
\begin{eqnarray*}
f:\{(a,b)\in A \times A| a^2+b^2 \ne 0\} &\to& (A \otimes _\mathbb R \mathbb C)^ \times=\mathbb S(A) \\
(a,b) &\mapsto& a \otimes 1+b\otimes i
\end{eqnarray*}
The verification is obvious.
\end{proof}

Let's consider characters of $\mathbb S(\mathbb C)$. Using the isomorphism $ \{(a,b)\in \mathbb C \times \mathbb C|a^2+b^2 \ne0\} \ni (x,y) \mapsto (x+yi,x-yi) \in \mathbb C ^\times \times \mathbb C ^\times $, we may identify $\mathbb S(\mathbb C)$ as $\mathbb C ^\times \times \mathbb C ^\times $, hence its character group is $\mathbb Z \times \mathbb Z$. For each pair $(a,b)\in \mathbb Z \times \mathbb Z$, let $\sigma_{a,b}$ be the character such that $\sigma_{a,b}(z,w)=z^aw^b$. Restricting $\sigma_{a,b}$ to $\mathbb S(\mathbb R)=\mathbb C^\times$ gives $\chi_{a,b}(z)=z^a\bar z^b$ for $z\in \mathbb C^ \times$.

Now, given a Hodge structure on a real vector space $V$, we can construct a representation $h$ of $\mathbb S(\mathbb R)$ on $V(\mathbb C)$ as follows: let $z\in \mathbb S(\mathbb R)$ act on $V^{p,q}$ by the character $\chi_{-p,-q}$. Conversely, given a representation $h:\mathbb S(\mathbb R) \to GL(V)$, we can define $V^{p,q}$ to be the subspace of $V(\mathbb C)$ with $\mathbb S(\mathbb R)$ action given by $h(z)v=\chi_{-p,-q}(z)v=z^{-p}\bar z^{-q} v$. It is clear that $V^{p,q}=\overline{V^{q,p}}$. Therefore, we also use $(V,h)$ to denote a Hodge structure.

The morphism between Hodge structures $f:(V,h_v)\to (W,h_w)$ can also be interpreted as a linear map satisfying $f(h_v(z)v)=h_w(z)f(v)$ for all $v \in V, z\in \mathbb S(\mathbb R) $, or, in other words, a morphism between representations $h_v$ and $h_w$. 

We often want to consider the variation of Hodge structures. Let $S$ be a connected complex manifold and $V$ a real vector space. Given weight $n$, suppose that, for each $s\in S$, we have a Hodge structure on $V$, denoted by $(V_s,h_s)$, with Hodge filtration given by $F_s^\bullet$. 

\begin{definition}
 \label{definition-continuity-and-holomorphicity}
\begin{enumerate}
 \item  A {\it continuous family of Hodge structures} on a topological space $S$ is a family $(h_s)_{s \in S}$ of Hodge structures on a fixed real vector space $V$, parametrized by the points of $S$, such that the dimension $d(p,q)$ of $V_s^{p,q}$ is locally constant in $s\in S$, and the map from $S$ to the product of Grassmannians defined by
$$
S \ni s  \mapsto (V_s^{p,q})_{p,q:d(p,q)\ne 0} \in \prod_{p,q:d(p,q)\ne0}G_{d(p,q)}(V(\mathbb C))
$$
is continuous.

\item A {\it holomorphic family of Hodge structures} on a connected complex manifold $S$ is a continuous family of Hodge structures $(h_s)_{s \in S}$ on a real vector space $V$, such hat the map $\phi$ froms $S$ to flag varieties defined by
$$
S \ni s \mapsto F_s ^\bullet \in G_\mathfrak d (V(\mathbb C))
$$
is holomorphic, where $\mathfrak d= (d_1,\cdots,d_p,\cdots)$ and $d_p=\text{dim}_\mathbb C F^p_s $. Note that continuity implies that $d_p$ does not vary with $s\in S$.
\end{enumerate}

\end{definition}

Note that it would not make sense to require the spaces $V^{p,q}$ to vary holomorphically, since the operation of taking the conjugate of a subspace does not preserve this property.


Some differential geometry shows that $\text{T}_{F_s^\bullet}(G_\mathfrak d (V(\mathbb C)))$, the tangent space of $G_\mathfrak d (V(\mathbb C))$ at $F_s^\bullet$, is naturally realized as a subspace of $\bigoplus _p \text{Hom}(F_s^p ,V(\mathbb C)/F_s^p)$. We will make a strong restriction and give the following definition:

\begin{definition}
 \label{definition-variation-of-Hodge-structures}
 A {\it variation of Hodge structures} is a holomorphic family of Hodge structures $(h_s)_{s \in S}$ such that the differential of the map $\phi:S \to G_\mathfrak d (V(\mathbb C))$ has its image in $\bigoplus _p \text{Hom}(F_s^p ,F_s^{p-1}/F_s^p)$. This condition is known as {\it Griffiths transversality}.
\end{definition}

In order to give the classification theorem, we are going to define polarizations.

\begin{definition}
 \label{definition-tensor-product}
 The {\it tensor product of Hodge structures} $V$ and $W$ of weights $m$ and $n$ is $V \otimes W$, a Hodge structure of weight $m+n$, satisfying 
$$
(V\otimes W)^{p,q}=\bigoplus_{r+r'=p \\ s+s'=q} V^{r,s} \otimes W^{r',s'}.
$$
In terms of representations of $\mathbb S(\mathbb R)$, $(V,h_v)\otimes (W,h_w)=(V \otimes W, h_v \otimes h_w)$.
\end{definition}

\begin{definition}
 \label{definition-weight-homomorphism}
 The {\it weight homomorphism} of $\mathbb S(\mathbb R)$ is the homomorphism $w:\mathbb R ^+ \to \mathbb S(\mathbb R)$, defined by $w(t)=t^{-1}$.
 \end{definition}
 
 We observe that a Hodge structure $V$ has weight $n$  if and only if its associated representation $h:\mathbb S(\mathbb R) \to GL(V(\mathbb C))$ satisfies $h(w(t))v=t^{-n} v$ for every $t\in \mathbb R^+, v\in V$.

One important example is the unique one-dimensional real vector space of weight $-2n$: $V=\mathbb R(n)$, whose underlying vector space is $\mathbb R$, and whose Hodge structure is given by $V(\mathbb C)=V^{-n,-n}=\mathbb C$, or equivalently, given by a representation $h:\mathbb S(\mathbb R) \to \mathbb C^ \times$ satisfying $h(w(t))=t^{2n}$ for all $t \in \mathbb R^+$ .

It is time to define Hodge tensors. 

\begin{definition}
 \label{definition-Hodge-tensors}
 A multilinear form  $t:V^r \to \mathbb R$ on a Hodge structure $V$ of weight $n$ is called a {\it Hodge tensor} if the map
$$
\underbrace{V\otimes V \otimes \cdots \otimes V}_{r \text{ copies}} \to \mathbb R(-nr/2)
$$
it defines is a morphism of Hodge structures. In other words, $t$ is a Hodge tensor if 
$$
t(h(z)v_1,\cdots,h(z)v_r)=(z \bar z)^{-nr/2}t(v_1,\cdots,v_r)
$$
for all $z \in \mathbb C^\times$ and $v_i \in V$.
\end{definition}

We can now move on to the heart of our definitions:

\begin{definition}
\label{definition-polarization}
A {\it polarization of a Hodge structure} $(V,h)$ of weight $n$ is a Hodge tensor $\psi:V \times V \to \mathbb R(-n)$, such that the map $\psi_{h(i)}$ defined by $V \times V \ni (v,w) \mapsto \psi(v,h(i)w) \in \mathbb R$ is symmetric and positive definite. 
\end{definition}

\subsection{Hermitian symmetric domains as parameter spaces for Hodge structures}
 \label{subsection-Hermitian-for-Hodge}
Now we explain and sketch a proof of Deligne's realization of hermitian symmetric domains as parameter spaces for Hodge structures. Let $V$ be a real vector space and $T$ be a family of tensors on $V$ including a nondegenerate bilinear form $t_0$, and let $d: \mathbb Z \times \mathbb Z \to \mathbb N$ be a function such that 
$$
\begin{cases}
d(p,q)=0 \text{ for almost all p,q };\\ d(q,p)=d(p,q);\\ d(p,q) =0  \text{ if } p+q \ne n.
\end{cases}
$$
Define $S(d,T)$ to be the set of Hodge structures $h$ on $V$ such that 

(1) $\text{dim} V_h^{p,q} =d(p,q)$ for all $p,q$;

(2) each $t\in T$ is a Hodge tensor for $h$;

(3) $t_0$ is a polarization for $h$.

By Remark \ref{remark-Hodge-structures}, we can endow $S(d,T)$ with the subset topology of  $\prod_{p,q:d(p,q)\ne 0} G_{d(p,q)}(V(\mathbb C))$.  

Our main theorem is the following:

\begin{theorem}
 \label{theorem-Hermitian-for-Hodge}
 Let $S^+$ be a connected component of $S(d,T)$.

(1) The space $S^+$ has a unique complex structure for which $(h_s)_{s\in S}$ is a holomorphic family of Hodge structures.

(2) With this complex structure, $S^+$ is a hermitian symmetric domain if $(h_s)_{s\in S}$ is a variation of Hodge structures.

(3) Every irreducible hermitian symmetric domain is of the form $S^+$ for a suitable choice of $V,d, T$.
\end{theorem}


\begin{proof}

(Sketch)

(1) Let $G$ be the smallest algebraic subgroup of $GL(V)$ such that $h(\mathbb S) \subseteq G$ for all $h \in S^+$.  Take any $h_0 \in S^+$, then for all $g \in G(\mathbb R)^0$, $gh_0g^{-1}\in S^+$. It was proven by Deligne \cite{Deligne-Shimura} that the map $G(\mathbb R)^0 \ni g\mapsto gh_0g^{-1} \in S^+$ is surjective. Let $K$ be the subgroup of $G(\mathbb R)^0$ fixing $h_0$, then $S^+ \cong G(\mathbb R)^0/K$. And since $K$ is closed, $S^+$ now admits a smooth manifold structure. Therefore we may consider its tangent space $T$ at $h_0$, which is the quotient of Lie algebras $\mathfrak g / \mathfrak k$. It suffices to show that, under the embedding $S^+\hookrightarrow G_ \mathfrak d(V(\mathbb C))$ coming from the Hodge filtration (notation as in Definition \ref{definition-continuity-and-holomorphicity}), $\mathfrak g / \mathfrak k$ is a complex subspace of the tangent space of the Grassmannian.

Note that $V$ has a Hodge structure $h_0$, which induces a Hodge structure on $W:=V\otimes V ^* =\text{End}V = \mathfrak{gl}(V)$. What is more, $W$ has weight 0, and its Hodge structure restricts to a Hodge structure on the subspace $\mathfrak g$ (which, in terms of the action of the Deligne torus $\mathbb S$, is simply the composition of $h_0:\mathbb S\to G$ with the adjoint representation).
It is a general fact that, if $W$ is a Hodge structure of weight 0, setting $W^{00}=W^{0,0} \cap W$ we have $W/W^{00}=W(\mathbb C)/ F^0$. Indeed, $W^{00}=F^0 \cap \overline{F^0} \cap W =$ the kernel of the surjective map $W \to W(\mathbb C)/F^0$.

Since $K$ is the stabilizer of $h_0$, we have $\mathfrak g^{00}=\mathfrak k$, and  therefore $T=\mathfrak g /\mathfrak g ^{00} = \mathfrak g(\mathbb C)/F^0_{\mathfrak g}$, a complex subspace of  $W/W^{00} = W(\mathbb C)/F_W^0$. The latter space is none other than the tangent space of $G_ \mathfrak d(V(\mathbb C))$ at $h_0$. This shows that $S^+$ can be identified as a complex submanifold of $G_ \mathfrak d(V(\mathbb C))$, hence admits a complex structure, as desired.

(2) Let $G_{\text{ad}}$ be the adjoint group of $G$. We want to apply Theorem \ref{theorem-classification-hermitian} to $G_{\text{ad}}$. For all $r\in \mathbb R^\times$, $h(r)$ acts as $r^{-n}$ on $V$, therefore belongs to the center of $\text{GL}(V)$. Therefore, we can define a homomorphism $s_0:S^1 \ni z\mapsto h_0(\sqrt z) \in G_{\text{ad}}$. Let $C=h_0(i)$.  Consider the faithful representation $G \to GL(V)$. Since $t_0$ is a Hodge tensor for $h$, $t_0$ is invariant under $h(z)$, for any $h\in S^+$ and $z\in \mathbb C^ \times$; therefore, $t_0$ is $G$-invariant.  The form $(v,w)\mapsto t_0(v, Cw)$ is symmetric and positive definite, defining a Cartan involution $g\mapsto g^{-t}$ (transpose under this inner product) on $\text{GL}(V)$, by Example \ref{reductiveforms-example-Cartan-decomposition-GL}, which leaves $G$ stable; therefore, $\text{Ad}C=\text{Ad}(s_0(-1))$ is a Cartan involution of $G$. Griffiths transversality of $h_0$ ensures that $s_0$ is minuscule condition (a); condition (c) is clear. Hence, by Theorem \ref{theorem-classification-hermitian}, the set of all conjugates $u$ of $s_0$ by $G_{\text{ad}}(\mathbb R)^0$ admits the structure of a hermitian symmetric domain.  Since for each $u$, we can obtain an $h\in S^+$ as follows: $\mathbb S(\mathbb R) \ni z  \mapsto u(z/\bar z)\in GL(V)$, this set can be identified with $S^+$.

(3) Let $D$ be an irreducible symmetric domain.  Let $G$ be the connected adjoint group such that $G(\mathbb R)^0$ is the identity component of the holomorphic automorphisms of $D$ (Lemma \ref{lemma-hermitian-automorphisms-algebraic}). Choose a faithful representation $G \to GL(V)$, and let $t_0$ be a nondegenerate $G$-invariant bilinear form on $V$. We can find a set of tensors $T$ containing $t_0$ such that $G$ is the subgroup of $GL(V)$ fixing each $t \in T$. Fix a point $x\in D$, let $s_0:U_1\to G$ be the corresponding homomorphism (Lemma \ref{lemma-S1-symmetry}), and let $h_0$ be a Hodge structure on $V$ obtained from $s_0$ using (2). Then all $t \in T$ are Hodge tensors for $h_0$ and $t_0$ is a polarization. Now we can check that $D$ is naturally identified with the component of $S(d,T)^+$ containing this Hodge structure. 
\end{proof}



\input{chapters}


\bibliography{my}
\bibliographystyle{amsalpha}

\end{document}


